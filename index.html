<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>10円ゲーム & ミニゲーム集</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    h1, h2, h3 {
      text-align: center;
    }

    button {
      cursor: pointer;
      border: none;
      padding: 10px 20px;
      margin: 8px;
      font-size: 16px;
      border-radius: 6px;
      background: #caa55a;
      color: #222;
      box-shadow: 0 3px 0 #7b6432;
      transition: transform 0.05s ease, box-shadow 0.05s ease, filter 0.1s;
    }

    button:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #7b6432;
      filter: brightness(0.9);
    }

    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .screen {
      display: none;
      width: 100%;
      max-width: 480px;
      padding: 16px;
      box-sizing: border-box;
    }

    .screen.active {
      display: block;
    }

    .panel {
      background: #222;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 0 0 2px #555;
      margin-top: 16px;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 4px;
      border: 1px solid #666;
      box-sizing: border-box;
      background: #111;
      color: #eee;
    }

    .center {
      text-align: center;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .small {
      font-size: 12px;
      opacity: 0.8;
    }

    #gameContainer {
      position: relative;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      border: 4px solid #5a4120;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }

    #gameCanvas {
      display: block;
      width: 100%;
      height: auto;
      background: #000;
    }

    .top-right-menu {
      position: fixed;
      top: 8px;
      right: 8px;
      z-index: 100;
    }

    .msg {
      margin-top: 6px;
      font-size: 13px;
      min-height: 1.4em;
    }

    .menu-title {
      font-size: 20px;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    /* レバー：reba1 の位置の横にバーを置くためのコンテナ */
    #leverOverlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* スライダーだけにイベントを通す */
    }

    .lever-ui {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 4px;
      pointer-events: auto;
    }

    .lever-image {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #666;
      background: #111;
      position: relative;
      flex-shrink: 0;
    }

    .lever-stick {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 4px;
      height: 18px;
      background: #ccc;
      transform-origin: bottom center;
      transform: translate(-50%, 0) rotate(0deg);
    }

    .lever-slider {
      width: 70px;
    }

    .lever-label {
      font-size: 10px;
      opacity: 0.9;
      min-width: 20px;
      text-align: left;
    }
  </style>
</head>
<body>

<div class="top-right-menu">
  <button id="backToMenuBtn" style="font-size:12px; padding:6px 10px;">メニューへ</button>
</div>

<!-- 0. 入口メニュー -->
<div id="screen-menu" class="screen active">
  <div class="panel">
    <h1 class="menu-title">ミニゲーム選択</h1>
    <div class="center">
      <button id="toNameInputBtn">10円ゲーム</button><br>
      <button id="toJankenBtn">じゃんけんゲーム</button>
    </div>
  </div>
</div>

<!-- 1. 名前入力画面 -->
<div id="screen-name" class="screen">
  <div class="panel">
    <h2>名前を入力してください</h2>
    <input type="text" id="playerNameInput" placeholder="未入力なら『Player』になります">
    <div class="center">
      <button id="decideNameBtn">決定</button>
    </div>
  </div>
</div>

<!-- 2. 10円ゲーム画面 -->
<div id="screen-10yen" class="screen">
  <div class="panel">
    <div class="status-bar">
      <div>PLAYING：<span id="playingName">-</span></div>
      <div>WAITING：<span id="waitingNames">0人</span></div>
    </div>
    <div class="small" id="stateLabel">状態：接続中...</div>

    <div id="gameContainer">
      <canvas id="gameCanvas" width="282" height="521"></canvas>
      <!-- レバーUIをキャンバス上に重ねる -->
      <div id="leverOverlay"></div>
    </div>

    <div class="center" style="margin-top:8px;">
      <button id="insertCoinBtn">10円を入れる</button>
      <button id="waitBtn">待機する</button>
      <button id="endGameBtn">ゲームを終わる</button>
    </div>

    <div class="msg" id="infoMsg"></div>
    <div class="small">
      ・誰もいない時：今なら遊べます<br>
      ・PLAYING：○○が挑戦中（観戦のみ）<br>
      ・待機：次に遊びたい人：n人
    </div>
  </div>
</div>

<!-- 3. じゃんけんゲーム画面（仮） -->
<div id="screen-janken" class="screen">
  <div class="panel">
    <h2>じゃんけんゲーム（仮）</h2>
    <p class="small">ここは後で janken.html に分離予定。いったんダミー実装。</p>
    <div class="center">
      <button id="jankenDummyBtn">じゃんけん！（仮）</button>
      <div id="jankenResult" class="msg"></div>
    </div>
  </div>
</div>

<script type="module">
  // ==========================
  // Firebase 初期化
  // ==========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  import {
    getDatabase,
    ref,
    onValue,
    set,
    update,
    push,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCC7KAv7V4j1Z6-o1Y8ikmb3r5htN9O_aA",
    authDomain: "zzgohan-280.firebaseapp.com",
    databaseURL: "https://zzgohan-280-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "zzgohan-280",
    storageBucket: "zzgohan-280.firebasestorage.app",
    messagingSenderId: "459336048542",
    appId: "1:459336048542:web:ff6c825dec81cc7df8008f",
    measurementId: "G-JX4RP9LWR3"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  // ==========================
  // 画面切り替え
  // ==========================
  const screens = {
    menu: document.getElementById('screen-menu'),
    name: document.getElementById('screen-name'),
    ten: document.getElementById('screen-10yen'),
    janken: document.getElementById('screen-janken'),
  };

  function showScreen(key) {
    Object.values(screens).forEach(el => el.classList.remove('active'));
    screens[key].classList.add('active');
  }

  document.getElementById('toNameInputBtn').addEventListener('click', () => {
    showScreen('name');
  });
  document.getElementById('toJankenBtn').addEventListener('click', () => {
    showScreen('janken');
  });
  document.getElementById('backToMenuBtn').addEventListener('click', () => {
    showScreen('menu');
  });

  // ==========================
  // 名前管理
  // ==========================
  const nameInput = document.getElementById('playerNameInput');
  const decideNameBtn = document.getElementById('decideNameBtn');

  let myName = localStorage.getItem('10yen_name') || '';
  if (myName) nameInput.value = myName;

  decideNameBtn.addEventListener('click', () => {
    const v = nameInput.value.trim();
    myName = v || 'Player';
    localStorage.setItem('10yen_name', myName);
    showScreen('ten');
  });

  // ==========================
  // Firebase 状態
  // ==========================
  const playingNameEl = document.getElementById('playingName');
  const waitingNamesEl = document.getElementById('waitingNames');
  const stateLabelEl = document.getElementById('stateLabel');
  const infoMsgEl = document.getElementById('infoMsg');

  const insertCoinBtn = document.getElementById('insertCoinBtn');
  const waitBtn = document.getElementById('waitBtn');
  const endGameBtn = document.getElementById('endGameBtn');

  const PLAYING_REF = ref(db, 'tenyenGame/playing');
  const WAITING_REF = ref(db, 'tenyenGame/waiting');
  const LAST_ACTION_REF = ref(db, 'tenyenGame/lastAction');

  let currentPlaying = null;
  let waitingList = [];

  function calcState() {
    if (!currentPlaying || !currentPlaying.name) return 'A';
    if (currentPlaying.name === myName) return 'C';
    return 'B';
  }

  function updateUIState() {
    const st = calcState();
    if (st === 'A') {
      stateLabelEl.textContent = '状態：今なら遊べます';
      insertCoinBtn.disabled = false;
      waitBtn.disabled = false;
      endGameBtn.disabled = true;
      setLeverEnabled(false);
    } else if (st === 'B') {
      stateLabelEl.textContent = `状態：${currentPlaying?.name || '-'} が挑戦中（観戦中）`;
      insertCoinBtn.disabled = true;
      waitBtn.disabled = false;
      endGameBtn.disabled = true;
      setLeverEnabled(false);
    } else {
      stateLabelEl.textContent = '状態：あなたがプレイ中';
      insertCoinBtn.disabled = true;
      waitBtn.disabled = true;
      endGameBtn.disabled = false;
      setLeverEnabled(true);
    }

    if (waitingList.length === 0) {
      waitingNamesEl.textContent = '0人';
    } else {
      const names = waitingList.map(w => w.name).join(' / ');
      waitingNamesEl.textContent = `${waitingList.length}人（${names}）`;
    }

    playingNameEl.textContent = currentPlaying?.name || '-';
  }

  function setLeverEnabled(flag) {
    leverStates.forEach(l => {
      l.slider.disabled = !flag;
    });
  }

  onValue(PLAYING_REF, snap => {
    currentPlaying = snap.val() || null;
    updateUIState();
  });

  onValue(WAITING_REF, snap => {
    const val = snap.val() || {};
    waitingList = Object.keys(val).map(id => ({
      id,
      name: val[id].name || 'Player'
    }));
    updateUIState();
  });

  function touchAction() {
    update(LAST_ACTION_REF, { time: serverTimestamp() });
  }

  insertCoinBtn.addEventListener('click', async () => {
    const st = calcState();
    if (st !== 'A') return;
    const name = myName || 'Player';
    await set(PLAYING_REF, { name });
    await set(WAITING_REF, {});
    touchAction();
    infoMsgEl.textContent = '10円が投入されました。レバーで狙ってください。';
    spawnCoinAtSafeStart();
  });

  waitBtn.addEventListener('click', async () => {
    const name = myName || 'Player';
    const already = waitingList.find(w => w.name === name);
    if (already) {
      infoMsgEl.textContent = 'すでに待機リストに入っています。';
      return;
    }
    const newRef = push(WAITING_REF);
    await set(newRef, { name, time: serverTimestamp() });
    touchAction();
    infoMsgEl.textContent = '待機列に入りました。譲り合って遊んでください。';
  });

  endGameBtn.addEventListener('click', async () => {
    const st = calcState();
    if (st !== 'C') return;
    await set(PLAYING_REF, null);
    touchAction();
    infoMsgEl.textContent = 'ゲームを終了しました。';
    resetCoin();
  });

  let idleTimer = null;
  ['click', 'input'].forEach(ev => {
    document.addEventListener(ev, () => {
      if (calcState() === 'C') {
        if (idleTimer) clearTimeout(idleTimer);
        idleTimer = setTimeout(async () => {
          if (calcState() === 'C') {
            await set(PLAYING_REF, null);
            infoMsgEl.textContent = '操作がなかったため、自動で終了しました。';
            resetCoin();
          }
        }, 60 * 1000);
      }
    });
  });

  // ==========================
  // PNG 読み込み＆物理
  // ==========================
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const leverOverlay = document.getElementById('leverOverlay');

  const images = {
    map: null,
    ren: null,
    ana: null,
    atari: null,
    kaisi: null,
    reba: null,
    reba1: null,
  };

  const hitCanvas = document.createElement('canvas');
  const hitCtx = hitCanvas.getContext('2d');
  let renData = null;
  let anaData = null;
  let atariData = null;
  let kaisiData = null;

  function loadImage(key, url) {
    return new Promise((resolve, reject) => {
      if (!url) {
        resolve();
        return;
      }
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => { images[key] = img; resolve(); };
      img.onerror = reject;
      img.src = url;
    });
  }

  async function loadAssets() {
    const base = "https://raw.githubusercontent.com/yumemiru28000/10en-game/main";

    await loadImage('map',   `${base}/map.png`);
    await loadImage('ren',   `${base}/ren.png`);
    await loadImage('ana',   `${base}/ana.png`);
    await loadImage('atari', `${base}/atari.png`);
    await loadImage('kaisi', `${base}/kaisi.png`);
    await loadImage('reba',  `${base}/reba.png`);
    await loadImage('reba1', `${base}/reba1.png`);

    hitCanvas.width  = canvas.width;
    hitCanvas.height = canvas.height;

    if (images.ren) {
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.ren,0,0,hitCanvas.width,hitCanvas.height);
      renData = hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
    }
    if (images.ana) {
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.ana,0,0,hitCanvas.width,hitCanvas.height);
      anaData = hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
    }
    if (images.atari) {
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.atari,0,0,hitCanvas.width,hitCanvas.height);
      atariData = hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
    }
    if (images.kaisi) {
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.kaisi,0,0,hitCanvas.width,hitCanvas.height);
      kaisiData = hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
      detectStartCandidate();
    }

    setupLeversUI();
  }

  function isBlackPixel(imgData,x,y) {
    if (!imgData) return false;
    const ix = Math.floor(x);
    const iy = Math.floor(y);
    if (ix < 0 || iy < 0 || ix >= imgData.width || iy >= imgData.height) return false;
    const idx = (iy * imgData.width + ix) * 4;
    const r = imgData.data[idx];
    const g = imgData.data[idx+1];
    const b = imgData.data[idx+2];
    const a = imgData.data[idx+3];
    if (a < 20) return false;
    const th = 40;
    return (r < th && g < th && b < th);
  }

  // 10円玉（表示と当たり判定はこの円）
  const coin = {
    x: canvas.width/2,
    y: canvas.height/2,
    vx: 0,
    vy: 0,
    r: 8,  // 小さめ
    inPlay: false,
    cleared: false,
    failed: false,
    angle: 0, // 回転角
  };

  let startCandidates = []; // kaisi 黒ピクセル一覧

  function detectStartCandidate() {
    if (!kaisiData) return;
    const w = kaisiData.width;
    const h = kaisiData.height;
    startCandidates = [];
    for (let y=0; y<h; y++) {
      for (let x=0; x<w; x++) {
        if (isBlackPixel(kaisiData,x,y)) {
          startCandidates.push({x,y});
        }
      }
    }
    if (startCandidates.length === 0) {
      startCandidates.push({x:w/2,y:h/2});
    }
  }

  function spawnCoinAtSafeStart() {
    // kaisi 黒の中からランダムに取り、そこから少し下探索して「ren と被らない」場所を探す
    if (startCandidates.length === 0) {
      coin.x = canvas.width/2;
      coin.y = canvas.height/2;
    } else {
      const cand = startCandidates[Math.floor(Math.random()*startCandidates.length)];
      let sx = cand.x;
      let sy = cand.y;

      // 下方向に少しスキャンして「壁が無い」位置を探す
      for (let dy=0; dy<20; dy++) {
        const tx = sx;
        const ty = sy + dy;
        // 円の外周8点が ren 黒と当たらないかチェック
        let ok = true;
        for (let i=0;i<8;i++){
          const ang = Math.PI*2*i/8;
          const ex = tx + Math.cos(ang)*coin.r;
          const ey = ty + Math.sin(ang)*coin.r;
          if (renData && isBlackPixel(renData,ex,ey)) {
            ok = false;
            break;
          }
        }
        if (ok) {
          sx = tx;
          sy = ty;
          break;
        }
      }
      coin.x = sx;
      coin.y = sy;
    }
    coin.vx = 0;
    coin.vy = 0;
    coin.inPlay = true;
    coin.cleared = false;
    coin.failed = false;
    coin.angle = 0;
  }

  function resetCoin() {
    coin.inPlay = false;
    coin.cleared = false;
    coin.failed = false;
  }

  // 重力など（1.5倍くらい強め）
  const gravity = 0.7;   // px/frame^2
  const friction = 0.012;
  const bounce = 0.25;

  function updatePhysics() {
    if (!coin.inPlay) return;
    if (coin.cleared || coin.failed) return;

    // 重力（常に下）
    coin.vy += gravity;

    // 空気抵抗
    coin.vx *= (1 - friction);
    coin.vy *= (1 - friction);

    let nextX = coin.x + coin.vx;
    let nextY = coin.y + coin.vy;

    // レーン：斜面に沿って転がす（壁を貫通させない）
    if (renData) {
      const sampleCount = 12;
      let hitCount = 0;
      let nxSum = 0;
      let nySum = 0;

      for (let i=0;i<sampleCount;i++){
        const ang = Math.PI*2*i/sampleCount;
        const sx = nextX + Math.cos(ang)*coin.r;
        const sy = nextY + Math.sin(ang)*coin.r;
        if (isBlackPixel(renData,sx,sy)){
          const nx = Math.cos(ang);
          const ny = Math.sin(ang);
          nxSum += nx;
          nySum += ny;
          hitCount++;
        }
      }

      if (hitCount>0){
        // 平均法線
        let nx = nxSum/hitCount;
        let ny = nySum/hitCount;
        const nLen = Math.sqrt(nx*nx+ny*ny) || 1;
        nx/=nLen; ny/=nLen;

        // 速度を法線・接線分解
        const vDotN = coin.vx*nx + coin.vy*ny;
        const vnX = vDotN*nx;
        const vnY = vDotN*ny;
        const vtX = coin.vx - vnX;
        const vtY = coin.vy - vnY;

        // 壁の中にめり込まないよう、法線成分をつぶして接線方向だけ残す＋ほんの少しバウンド
        coin.vx = vtX - vnX*bounce*0.3;
        coin.vy = vtY - vnY*bounce*0.3;

        nextX = coin.x + coin.vx;
        nextY = coin.y + coin.vy;
      }
    }

    coin.x = nextX;
    coin.y = nextY;

    // 枠
    if (coin.x-coin.r<0){ coin.x = coin.r; coin.vx*=-bounce; }
    if (coin.x+coin.r>canvas.width){ coin.x = canvas.width-coin.r; coin.vx*=-bounce; }
    if (coin.y-coin.r<0){ coin.y = coin.r; coin.vy*=-bounce; }
    if (coin.y+coin.r>canvas.height){ coin.y = canvas.height-coin.r; coin.vy*=-bounce; }

    // 失敗穴
    if (anaData && isBlackPixel(anaData,coin.x,coin.y)){
      coin.inPlay=false;
      coin.failed=true;
      infoMsgEl.textContent='失敗…。また挑戦してね。';
    }
    // 成功穴
    if (atariData && !coin.failed && !coin.cleared && isBlackPixel(atariData,coin.x,coin.y)){
      coin.inPlay=false;
      coin.cleared=true;
      infoMsgEl.textContent='SUCCESS！おめでとう！';
    }

    // 回転：速度に比例・上限あり（高速で回転しすぎないように）
    const speed = Math.sqrt(coin.vx*coin.vx + coin.vy*coin.vy);
    const maxSpin = 0.25; // rad/frame 上限
    const spin = Math.min(maxSpin, speed*0.03);
    coin.angle += spin;
  }

  // ==========================
  // レバー UI（reba1 の近くに配置）
  // ==========================
  const leverStates = [];

  function setupLeversUI() {
    leverOverlay.innerHTML = '';
    leverStates.length = 0;

    const w = canvas.width;
    const h = canvas.height;

    // 左右3本ずつの位置（ここは map/reba1 に合わせて後で微調整してOK）
    const leverPositions = [
      // 左側（x: 少し外寄り、y: 上中下）
      { index: 0, side: 'left',  x: w*0.1, y: h*0.2 },
      { index: 1, side: 'left',  x: w*0.1, y: h*0.5 },
      { index: 2, side: 'left',  x: w*0.1, y: h*0.8 },
      // 右側
      { index: 3, side: 'right', x: w*0.9, y: h*0.2 },
      { index: 4, side: 'right', x: w*0.9, y: h*0.5 },
      { index: 5, side: 'right', x: w*0.9, y: h*0.8 },
    ];

    leverPositions.forEach(lp => {
      const ui = document.createElement('div');
      ui.className = 'lever-ui';
      ui.style.left = `${lp.x - 18}px`; // 画像中心合わせ（36px/2）
      ui.style.top  = `${lp.y - 18}px`;

      // レバー画像
      const imgBox = document.createElement('div');
      imgBox.className = 'lever-image';
      if (images.reba1) {
        imgBox.style.backgroundImage = `url(${images.reba1.src})`;
        imgBox.style.backgroundSize = 'cover';
        imgBox.style.backgroundPosition = 'center';
      }

      const stick = document.createElement('div');
      stick.className = 'lever-stick';
      imgBox.appendChild(stick);

      // スライダー（横に出す）
      const slider = document.createElement('input');
      slider.type = 'range';
      slider.min = '0';
      slider.max = '100';
      slider.step = '1';
      slider.value = '0';
      slider.className = 'lever-slider';

      const label = document.createElement('span');
      label.className = 'lever-label';
      label.textContent = lp.side === 'left' ? `L${lp.index+1}` : `R${lp.index-2}`;

      // 左レバーは右側にスライダー、右レバーは左側にスライダー
      if (lp.side === 'left') {
        ui.appendChild(imgBox);
        ui.appendChild(slider);
        ui.appendChild(label);
      } else {
        ui.appendChild(label);
        ui.appendChild(slider);
        ui.appendChild(imgBox);
      }

      leverOverlay.appendChild(ui);

      const lever = { ...lp, slider, stick, value: 0 };
      leverStates.push(lever);

      let prev = 0;

      slider.addEventListener('input', () => {
        if (calcState() !== 'C') {
          slider.value = '0';
          return;
        }

        // 「重く感じる」＝ 値が高くなるほど入力を鈍くする：ここでは感覚的な演出は難しいので、
        // 代わりに「高い値は一気に動きづらい」ようにクリッピングする手もあるが、
        // まずはシンプルに値→角度＆パワーとして扱う。

        const v = Number(slider.value);
        lever.value = v;

        const angle = -90 * (v/100);
        lever.stick.style.transform = `translate(-50%, 0) rotate(${angle}deg)`;

        // 引いてから離す（v が急に小さくなった）のを検知
        if (prev > 20 && v < 5) {
          const power = prev / 100;
          fireLever(lever, power);
        }

        prev = v;
        touchAction();
      });
    });
  }

  function fireLever(lever, power) {
    if (!coin.inPlay || coin.cleared || coin.failed) return;

    const w = canvas.width;
    const h = canvas.height;

    const colWidth = w / 3;
    const rowHeight = h / 3;
    const side = lever.side;

    // index 0,1,2 (left) / 3,4,5 (right)
    const rowIndex = side === 'left' ? lever.index : lever.index - 3;
    const colIndex = side === 'left' ? 0 : 2;

    const colXMin = colWidth * colIndex;
    const colXMax = colXMin + colWidth;
    const rowYMin = rowHeight * rowIndex;
    const rowYMax = rowYMin + rowHeight;

    const inArea =
      coin.x >= colXMin && coin.x <= colXMax &&
      coin.y >= rowYMin && coin.y <= rowYMax;

    if (!inArea) return; // 空振り

    // 打ち出す方向：レバー→盤面の内側（左右反対）
    const dirX = (side === 'left') ? 1 : -1;
    const baseSpeed = 12;          // 前回より約1.5倍強め
    const speed = baseSpeed * power;

    coin.vx += dirX * speed;
    coin.vy -= speed * 0.5;

    infoMsgEl.textContent = `${side === 'left' ? '左' : '右'}レバーから発射！`;

    // バネのように元の位置へ
    lever.slider.value = '0';
    lever.value = 0;
    lever.stick.style.transform = 'translate(-50%, 0) rotate(0deg)';
  }

  // ==========================
  // 描画
  // ==========================
  function drawGame() {
    if (images.map) {
      ctx.drawImage(images.map,0,0,canvas.width,canvas.height);
    } else {
      ctx.fillStyle='#222';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    if (coin.inPlay || coin.cleared || coin.failed) {
      ctx.save();
      ctx.translate(coin.x,coin.y);
      ctx.rotate(coin.angle);

      const grad = ctx.createRadialGradient(0,0,coin.r*0.2,0,0,coin.r);
      grad.addColorStop(0,'#ffe8a0');
      grad.addColorStop(1,'#c08a2a');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(0,0,coin.r,0,Math.PI*2);
      ctx.fill();

      ctx.fillStyle = '#5b3a10';
      ctx.font = 'bold 8px system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('10',0,0);

      ctx.restore();
    }
  }

  function gameLoop(){
    requestAnimationFrame(gameLoop);
    updatePhysics();
    drawGame();
  }

  // ==========================
  // じゃんけん（仮）
  // ==========================
  const jankenDummyBtn = document.getElementById('jankenDummyBtn');
  const jankenResult = document.getElementById('jankenResult');
  jankenDummyBtn.addEventListener('click', () => {
    const hands = ['グー','チョキ','パー'];
    const my = hands[Math.floor(Math.random()*3)];
    const cpu = hands[Math.floor(Math.random()*3)];
    let res;
    if (my===cpu) res='あいこ';
    else if(
      (my==='グー' && cpu==='チョキ') ||
      (my==='チョキ' && cpu==='パー') ||
      (my==='パー' && cpu==='グー')
    ) res='あなたの勝ち';
    else res='あなたの負け';
    jankenResult.textContent = `あなた：${my} / CPU：${cpu} → ${res}`;
  });

  // ==========================
  // 初期化
  // ==========================
  loadAssets().then(() => {
    spawnCoinAtSafeStart();
    gameLoop();
  });

</script>

</body>
</html>
