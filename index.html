<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>10円ゲーム マップ＆レバー実験（棒編集付き）</title>
  <style>
    body {
      margin: 0;
      background: #222;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow: hidden;
    }

    #uiPanel {
      width: 210px;
      background: #111;
      border-right: 1px solid #333;
      padding: 8px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }

    #leverArea {
      position: relative;
      width: 180px;
      height: 140px;
      margin: 0 auto;
      border: 1px solid #444;
      background: #181818;
      border-radius: 4px;
      touch-action: none;
    }

    #lever {
      position: absolute;
      width: 12px;
      height: 80px;
      background: #ccc;
      left: 50%;
      bottom: 15px;
      transform-origin: 50% 100%;
      transform: translateX(-50%) rotate(0deg);
      cursor: grab;
    }
    #lever:active {
      cursor: grabbing;
    }
    #lever::after {
      content: "";
      position: absolute;
      width: 30px;
      height: 12px;
      background: #ccc;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
    }
    #leverLabel {
      position: absolute;
      left: 4px;
      bottom: 4px;
      font-size: 10px;
      color: #aaa;
    }

    #leverInfo {
      font-size: 12px;
      line-height: 1.5;
    }

    #world {
      flex: 1;
      position: relative;
    }

    /* Matter.js canvas を背景にするため */
    #world canvas {
      display: block;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center center;
    }

    button {
      font-size: 12px;
      padding: 4px 8px;
      background: #333;
      color: #eee;
      border: 1px solid #555;
      border-radius: 3px;
      cursor: pointer;
      margin-bottom: 4px;
    }
    button:hover {
      background: #444;
    }
    input[type="number"], input[type="password"] {
      width: 70px;
      background: #222;
      border: 1px solid #555;
      color: #eee;
      padding: 2px 4px;
      border-radius: 3px;
      margin-bottom: 4px;
    }

    #adminPanel {
      border-top: 1px solid #333;
      padding-top: 6px;
      margin-top: 6px;
      font-size: 11px;
    }
    #adminPanel.disabled {
      opacity: 0.4;
    }

    #adminStatus {
      font-size: 11px;
      color: #ccc;
      margin-bottom: 4px;
    }

    #stickInfo {
      font-size: 11px;
      color: #aaa;
    }
    #stickThickness {
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="uiPanel">
    <!-- レバー UI -->
    <div id="leverArea">
      <div id="lever"></div>
      <div id="leverLabel">レバー</div>
    </div>
    <div id="leverInfo">
      角度: <span id="angleText">0</span>°<br>
      引き具合(0～1): <span id="powerText">0.00</span>
    </div>

    <!-- 一般設定 -->
    <div>
      重力:
      <input id="gravity" type="number" step="0.1" value="1.0">
      <br>
      <button id="addCoin">10円を置く</button>
      <button id="resetWorld">10円リセット</button>
    </div>

    <!-- 運営モード -->
    <div id="adminPanel" class="disabled">
      <div><strong>運営モード</strong></div>
      <div id="adminStatus">未ログイン</div>
      パスワード:
      <input id="adminPass" type="password" placeholder="1122">
      <button id="adminLogin">ログイン</button>

      <div id="stickControls" style="margin-top:4px;">
        <button id="toggleStickEdit">棒編集モード: OFF</button><br>
        棒の太さ:
        <input id="stickThickness" type="range" min="5" max="50" value="20">
        <span id="stickThicknessLabel">20</span> px<br>
        <button id="resetSticks">棒 全リセット</button>
        <div id="stickInfo">
          棒編集モード中: キャンバス上を<br>
          2回クリックすると、その2点を<br>
          つなぐ棒が作られます。
        </div>
      </div>
    </div>
  </div>

  <div id="world"></div>

  <!-- Matter.js -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
  <script>
    // ============================================================
    // 設定用定数（既存のレバー設定 + 追加分）
    // ============================================================
    const REBA_HEAVINESS_EXPONENT = 3.0;   // 引くほど重く（非線形）
    const REBA_MAX_ANGLE_DEG      = 90;
    const REBA_LAUNCH_ANGLE_DEG   = -45;   // 打ち出し方向（度）
    const REBA_MAX_LAUNCH_SPEED   = 35;    // 最大打ち出し速度（少し強め）
    const REBA_DRAG_SENSITIVITY   = 0.5;
    const REBA_LAUNCH_RADIUS      = 30;

    // 10円（5.5g）+ 斜面でよく転がるように摩擦を弱める
    const COIN_RADIUS = 11;
    const COIN_MASS   = 0.0055;
    const COIN_FRICTION       = 0.02;  // 動摩擦かなり小さく
    const COIN_FRICTION_STATIC= 0.05;  // 静止摩擦も低め
    const COIN_FRICTION_AIR   = 0.0005;

    // 発射台の座標（マップ上で好きに変えられる）
    const REBA_LAUNCH_BASE_X = 260;
    const REBA_LAUNCH_BASE_Y = 320;

    // 中央に置く「ごくわずかな斜面」の角度（ラジアン）
    const REBA_TEST_SLOPE_ANGLE = 0.04;

    // マップ画像
    const MAP_IMAGE_URL = "https://raw.githubusercontent.com/yumemiru28000/10en-game/main/map.png";

    // ============================================================
    // Matter.js セットアップ
    // ============================================================
    const Engine = Matter.Engine;
    const Render = Matter.Render;
    const Runner = Matter.Runner;
    const Bodies = Matter.Bodies;
    const Composite = Matter.Composite;
    const Body = Matter.Body;
    const Mouse = Matter.Mouse;
    const MouseConstraint = Matter.MouseConstraint;

    const engine = Engine.create();
    const world  = engine.world;
    engine.world.gravity.y = 1.0;

    const canvasWidth  = window.innerWidth - 210; // UIパネル分
    const canvasHeight = window.innerHeight;

    const render = Render.create({
      element: document.getElementById('world'),
      engine: engine,
      options: {
        width: canvasWidth,
        height: canvasHeight,
        wireframes: false,
        background: '#000' // 後で map.png を上からかぶせる
      }
    });
    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

    // canvas 背景に map.png を貼る
    render.canvas.style.backgroundImage = `url("${MAP_IMAGE_URL}")`;
    render.canvas.style.backgroundSize = "contain";
    render.canvas.style.backgroundRepeat = "no-repeat";
    render.canvas.style.backgroundPosition = "center center";

    // ============================================================
    // 壁・フィールドなど
    // ============================================================
    const thickness = 40;

    const leftWall = Bodies.rectangle(20, canvasHeight / 2, thickness, canvasHeight, {
      isStatic: true,
      render: { fillStyle: "rgba(80,80,80,0.6)" }
    });
    const rightWall = Bodies.rectangle(canvasWidth - 20, canvasHeight / 2, thickness, canvasHeight, {
      isStatic: true,
      render: { fillStyle: "rgba(80,80,80,0.6)" }
    });
    const ceiling = Bodies.rectangle(canvasWidth / 2, 20, canvasWidth, thickness, {
      isStatic: true,
      render: { fillStyle: "rgba(80,80,80,0.6)" }
    });

    // 右下 大きめ斜面（既存）
    const floorAngle = -Math.PI / 8;
    const floorLength = 500;
    const slopedFloor = Bodies.rectangle(
      canvasWidth - 260,
      canvasHeight - 60,
      floorLength,
      20,
      {
        isStatic: true,
        angle: floorAngle,
        render: { fillStyle: "rgba(120,120,120,0.7)" }
      }
    );

    const cornerPost = Bodies.rectangle(
      canvasWidth - 350,
      canvasHeight - 150,
      20,
      80,
      {
        isStatic: true,
        render: { fillStyle: "rgba(160,160,160,0.7)" }
      }
    );

    // テスト用わずかな斜面
    const gentleSlope = Bodies.rectangle(
      canvasWidth / 2,
      canvasHeight / 2 + 80,
      350,
      10,
      {
        isStatic: true,
        angle: REBA_TEST_SLOPE_ANGLE,
        render: { fillStyle: "rgba(100,100,100,0.7)" }
      }
    );

    Composite.add(world, [leftWall, rightWall, ceiling, slopedFloor, cornerPost, gentleSlope]);

    // ============================================================
    // 棒（線分）編集機能（運営モード専用）
    // ============================================================
    const stickBodies = [];
    let isAdmin = false;
    let stickEditMode = false;
    let pendingPoint = null; // 1点目が入っているかどうか
    const adminPanelEl = document.getElementById("adminPanel");
    const adminStatusEl = document.getElementById("adminStatus");
    const adminPassEl   = document.getElementById("adminPass");
    const adminLoginBtn = document.getElementById("adminLogin");
    const toggleStickEditBtn = document.getElementById("toggleStickEdit");
    const resetSticksBtn     = document.getElementById("resetSticks");
    const stickThicknessInput= document.getElementById("stickThickness");
    const stickThicknessLabel= document.getElementById("stickThicknessLabel");

    let currentStickThickness = parseInt(stickThicknessInput.value, 10) || 20;

    stickThicknessInput.addEventListener("input", () => {
      currentStickThickness = parseInt(stickThicknessInput.value, 10) || 20;
      stickThicknessLabel.textContent = currentStickThickness;
    });
    stickThicknessLabel.textContent = currentStickThickness;

    adminLoginBtn.addEventListener("click", () => {
      if (adminPassEl.value === "1122") {
        isAdmin = true;
        adminStatusEl.textContent = "ログイン中（運営モード）";
        adminPanelEl.classList.remove("disabled");
      } else {
        adminStatusEl.textContent = "パスワード不正";
      }
    });

    toggleStickEditBtn.addEventListener("click", () => {
      if (!isAdmin) return;
      stickEditMode = !stickEditMode;
      toggleStickEditBtn.textContent = "棒編集モード: " + (stickEditMode ? "ON" : "OFF");
      if (!stickEditMode) pendingPoint = null;
    });

    resetSticksBtn.addEventListener("click", () => {
      if (!isAdmin) return;
      // すべての棒を削除
      for (const b of stickBodies) {
        Composite.remove(world, b);
      }
      stickBodies.length = 0;
      pendingPoint = null;
    });

    // canvas 上でクリック → 棒を追加
    const mouse = Mouse.create(render.canvas);
    const mouseConstraint = MouseConstraint.create(engine, {
      mouse,
      constraint: {
        stiffness: 0.1,
        render: { visible: false }
      }
    });
    Composite.add(world, mouseConstraint);

    render.mouse = mouse;

    render.canvas.addEventListener("mousedown", (e) => {
      if (!isAdmin || !stickEditMode) return;

      const rect = render.canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (!pendingPoint) {
        // 1点目
        pendingPoint = { x, y };
      } else {
        // 2点目 → 棒を作成
        const x1 = pendingPoint.x;
        const y1 = pendingPoint.y;
        const x2 = x;
        const y2 = y;
        const cx = (x1 + x2) / 2;
        const cy = (y1 + y2) / 2;
        const dx = x2 - x1;
        const dy = y2 - y1;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx);

        const stick = Bodies.rectangle(
          cx,
          cy,
          length,
          currentStickThickness,
          {
            isStatic: true,
            angle: angle,
            render: { fillStyle: "rgba(180,180,180,0.8)" }
          }
        );

        Composite.add(world, stick);
        stickBodies.push(stick);
        pendingPoint = null;
      }
    });

    // ============================================================
    // 10円玉
    // ============================================================
    const coins = [];

    function createCoin(x, y) {
      return Bodies.circle(x, y, COIN_RADIUS, {
        mass: COIN_MASS,
        restitution: 0.2,
        friction: COIN_FRICTION,
        frictionStatic: COIN_FRICTION_STATIC,
        frictionAir: COIN_FRICTION_AIR,
        render: {
          fillStyle: "#cc8844",
          strokeStyle: "#ddbb77",
          lineWidth: 2
        }
      });
    }

    function addCoinAt(x, y) {
      const c = createCoin(x, y);
      coins.push(c);
      Composite.add(world, c);
      return c;
    }

    // 初期10円
    addCoinAt(REBA_LAUNCH_BASE_X, REBA_LAUNCH_BASE_Y);

    // 発射台の見た目（スリット）
    const blockThickness = 20;
    const baseBlockWidth = 80;
    const slotUpper = Bodies.rectangle(
      REBA_LAUNCH_BASE_X,
      REBA_LAUNCH_BASE_Y - COIN_RADIUS - 5,
      baseBlockWidth,
      blockThickness,
      { isStatic: true, render: { fillStyle: "rgba(60,60,60,0.8)" } }
    );
    const slotLower = Bodies.rectangle(
      REBA_LAUNCH_BASE_X,
      REBA_LAUNCH_BASE_Y + COIN_RADIUS + 5,
      baseBlockWidth,
      blockThickness,
      { isStatic: true, render: { fillStyle: "rgba(60,60,60,0.8)" } }
    );
    const slotLeftWall = Bodies.rectangle(
      REBA_LAUNCH_BASE_X - baseBlockWidth / 2 + 10,
      REBA_LAUNCH_BASE_Y,
      20,
      COIN_RADIUS * 4,
      { isStatic: true, render: { fillStyle: "rgba(60,60,60,0.8)" } }
    );
    Composite.add(world, [slotUpper, slotLower, slotLeftWall]);

    // ============================================================
    // レバー UI ロジック（既存をベースに）
    // ============================================================
    const leverEl = document.getElementById("lever");
    const angleTextEl = document.getElementById("angleText");
    const powerTextEl = document.getElementById("powerText");
    const gravityInput = document.getElementById("gravity");
    const addCoinBtn = document.getElementById("addCoin");
    const resetWorldBtn = document.getElementById("resetWorld");

    let leverAngleDeg = 0;
    const maxAngleDeg = REBA_MAX_ANGLE_DEG;
    let isDraggingLever = false;
    let dragStartY = 0;
    let dragStartAngle = 0;

    function calcPullPower() {
      const normalized = leverAngleDeg / maxAngleDeg;
      return Math.pow(normalized, REBA_HEAVINESS_EXPONENT);
    }

    function updateLeverVisual() {
      leverEl.style.transform = `translateX(-50%) rotate(${leverAngleDeg}deg)`;
      angleTextEl.textContent = leverAngleDeg.toFixed(1);
      powerTextEl.textContent = calcPullPower().toFixed(2);
    }

    function getLaunchDirection() {
      const rad = REBA_LAUNCH_ANGLE_DEG * Math.PI / 180;
      return { x: Math.cos(rad), y: Math.sin(rad) };
    }
    function getLaunchPower() {
      return calcPullPower() * REBA_MAX_LAUNCH_SPEED;
    }

    function releaseLeverAndLaunch() {
      const power = getLaunchPower();
      if (power <= 0.1) {
        leverAngleDeg = 0;
        updateLeverVisual();
        return;
      }
      const dir = getLaunchDirection();
      coins.forEach(c => {
        const dx = c.position.x - REBA_LAUNCH_BASE_X;
        const dy = c.position.y - REBA_LAUNCH_BASE_Y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < REBA_LAUNCH_RADIUS) {
          const vx = dir.x * power;
          const vy = dir.y * power;
          Body.setVelocity(c, { x: vx, y: vy });
        }
      });
      leverAngleDeg = 0;
      updateLeverVisual();
    }

    function startDragLever(startY) {
      isDraggingLever = true;
      dragStartY = startY;
      dragStartAngle = leverAngleDeg;
    }
    function moveDragLever(currentY) {
      if (!isDraggingLever) return;
      const dy = currentY - dragStartY;
      let newAngle = dragStartAngle + dy * REBA_DRAG_SENSITIVITY;
      newAngle = Math.max(0, Math.min(maxAngleDeg, newAngle));
      leverAngleDeg = newAngle;
      updateLeverVisual();
    }
    function endDragLever() {
      if (!isDraggingLever) return;
      isDraggingLever = false;
      releaseLeverAndLaunch();
    }

    // マウス
    leverEl.addEventListener("mousedown", e => {
      e.preventDefault();
      startDragLever(e.clientY);
    });
    window.addEventListener("mousemove", e => {
      if (!isDraggingLever) return;
      e.preventDefault();
      moveDragLever(e.clientY);
    });
    window.addEventListener("mouseup", e => {
      if (!isDraggingLever) return;
      e.preventDefault();
      endDragLever();
    });

    // タッチ
    leverEl.addEventListener("touchstart", e => {
      e.preventDefault();
      const t = e.touches[0];
      startDragLever(t.clientY);
    }, { passive: false });
    window.addEventListener("touchmove", e => {
      if (!isDraggingLever) return;
      e.preventDefault();
      const t = e.touches[0];
      moveDragLever(t.clientY);
    }, { passive: false });
    window.addEventListener("touchend", e => {
      if (!isDraggingLever) return;
      e.preventDefault();
      endDragLever();
    }, { passive: false });

    updateLeverVisual();

    // ============================================================
    // UI ボタン
    // ============================================================
    gravityInput.addEventListener("input", e => {
      const g = parseFloat(e.target.value) || 0;
      engine.world.gravity.y = g;
    });

    addCoinBtn.addEventListener("click", () => {
      const x = REBA_LAUNCH_BASE_X + (Math.random() * 20 - 10);
      const y = REBA_LAUNCH_BASE_Y + (Math.random() * 10 - 5);
      addCoinAt(x, y);
    });

    resetWorldBtn.addEventListener("click", () => {
      // 10円だけすべて消して、1枚戻す
      coins.forEach(c => Composite.remove(world, c));
      coins.length = 0;
      addCoinAt(REBA_LAUNCH_BASE_X, REBA_LAUNCH_BASE_Y);
      leverAngleDeg = 0;
      updateLeverVisual();
    });
  </script>
</body>
</html>
