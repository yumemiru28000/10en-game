<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>10円ゲーム：レバー式発射実験</title>
  <style>
    body {
      margin: 0;
      background: #222;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #world {
      flex: 1;
    }
    #ui-panel {
      width: 260px;
      background: #111;
      padding: 10px;
      box-sizing: border-box;
      border-left: 1px solid #444;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 14px;
    }
    #lever-area {
      position: relative;
      width: 80px;
      height: 260px;
      margin: 0 auto;
      background: #222;
      border-radius: 10px;
      border: 1px solid #555;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
    }
    #lever-slot {
      position: absolute;
      left: 50%;
      top: 20px;
      width: 8px;
      height: 220px;
      margin-left: -4px;
      background: #333;
      border-radius: 4px;
    }
    #lever-knob {
      position: absolute;
      left: 50%;
      width: 40px;
      height: 40px;
      margin-left: -20px;
      border-radius: 20px;
      background: #888;
      border: 2px solid #ccc;
      cursor: grab;
      box-shadow: 0 0 6px rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      user-select: none;
    }
    #lever-knob.dragging {
      cursor: grabbing;
      background: #aaa;
    }
    .label {
      font-size: 13px;
      color: #ccc;
    }
    .value {
      font-weight: bold;
      color: #0f0;
    }
    button {
      padding: 4px 8px;
      font-size: 13px;
    }
    .small {
      font-size: 11px;
      color: #999;
    }
  </style>
</head>
<body>

  <!-- Matter.js のキャンバス領域 -->
  <div id="world"></div>

  <!-- UI パネル（レバーなど） -->
  <div id="ui-panel">
    <div class="label">レバー式 10円玉発射装置</div>
    <div id="lever-area">
      <div id="lever-slot"></div>
      <div id="lever-knob">LEVER</div>
    </div>
    <div class="label">
      引き具合: <span id="pull-amount" class="value">0.00</span>（0〜1）
    </div>
    <div class="label">
      発射パワー: <span id="power" class="value">0.00</span>
    </div>
    <div class="label">
      重力: <input id="gravity" type="number" step="0.1" value="1" style="width:60px;"> (下向き)
    </div>
    <button id="spawn-coin">斜面の上に10円を出す</button>
    <button id="reset">全部リセット</button>
    <div class="small">
      操作：レバーを下方向にドラッグして指を離すと、<br>
      発射位置にいる10円玉を右上方向に打ち出します。
    </div>
  </div>

  <!-- Matter.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
  <script>
    // Matter.js エイリアス
    const Engine = Matter.Engine;
    const Render = Matter.Render;
    const Runner = Matter.Runner;
    const Bodies = Matter.Bodies;
    const Composite = Matter.Composite;
    const Body = Matter.Body;
    const Vector = Matter.Vector;

    // エンジンとワールド
    const engine = Engine.create();
    const world  = engine.world;
    engine.world.gravity.y = 1.0; // デフォルト重力

    const width  = window.innerWidth - 260; // UI 分を引いた幅
    const height = window.innerHeight;

    const render = Render.create({
      element: document.getElementById('world'),
      engine: engine,
      options: {
        width: width,
        height: height,
        wireframes: false,
        background: '#222'
      }
    });

    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

    // 10円玉のパラメータ
    const COIN_RADIUS = 11;
    const COIN_MASS   = 0.0055; // 5.5g

    // ステージ構成
    // 左下に斜面、その右側の角あたりに「発射位置」と「壁の小穴」イメージ
    const wallThickness = 40;

    // 画面境界の床・天井・左右壁（外枠）
    const floor = Bodies.rectangle(width/2, height + wallThickness/2, width, wallThickness, {
      isStatic: true,
      render: { fillStyle: '#333' }
    });
    const ceiling = Bodies.rectangle(width/2, -wallThickness/2, width, wallThickness, {
      isStatic: true,
      render: { fillStyle: '#333' }
    });
    const leftWall = Bodies.rectangle(-wallThickness/2, height/2, wallThickness, height, {
      isStatic: true,
      render: { fillStyle: '#333' }
    });
    const rightWall = Bodies.rectangle(width + wallThickness/2, height/2, wallThickness, height, {
      isStatic: true,
      render: { fillStyle: '#333' }
    });

    Composite.add(world, [floor, ceiling, leftWall, rightWall]);

    // 斜めの床（左下から右上へ軽く上っていく）
    // 中心と長さ・角度を決める
    const slopeLength = width * 0.9;
    const slopeAngle  = -Math.PI / 12; // -15度（右に行くほど少し下る感じにもできる）
    const slope = Bodies.rectangle(
      width*0.35,           // 中心X
      height*0.75,          // 中心Y
      slopeLength,
      30,
      {
        isStatic: true,
        angle: slopeAngle,
        render: { fillStyle: '#444' }
      }
    );
    Composite.add(world, slope);

    // 発射位置（斜面の右端近くの角あたり）
    const LAUNCH_X = width * 0.72;
    const LAUNCH_Y = height * 0.58;

    // 視覚的な「壁」と「小さな穴」を表現するため
    const launchWall = Bodies.rectangle(
      LAUNCH_X + 25,
      LAUNCH_Y - 10,
      40,
      80,
      {
        isStatic: true,
        render: { fillStyle: '#555' }
      }
    );
    Composite.add(world, launchWall);

    // 「10円より小さい隙間」イメージ：物理的には当たり判定なしのガイド用
    // → 描画専用の簡易オーバーレイをあとで Canvas に描くのはやや複雑なので、
    //    ここでは、発射穴用の小さなセンサー用 Body を作るが、
    //    反応しないように isSensor: true にしておく（壁ではない）
    const launchHole = Bodies.rectangle(
      LAUNCH_X,
      LAUNCH_Y,
      COIN_RADIUS * 1.2,   // 10円より少し小さい幅のイメージ
      COIN_RADIUS * 0.8,
      {
        isStatic: true,
        isSensor: true,
        render: {
          fillStyle: '#222',
          strokeStyle: '#999',
          lineWidth: 1
        }
      }
    );
    Composite.add(world, launchHole);

    // 10円玉生成
    const coins = [];

    function spawnCoinOnSlope() {
      // 斜面の左側上のほうから転がってくるように配置
      const x = width * 0.1 + Math.random() * 30;
      const y = height * 0.4;
      const coin = Bodies.circle(x, y, COIN_RADIUS, {
        mass: COIN_MASS,
        restitution: 0.2,
        friction: 0.1,
        frictionStatic: 0.5,
        frictionAir: 0.002,
        render: {
          fillStyle: '#cc8844',
          strokeStyle: '#ddbb77',
          lineWidth: 2
        }
      });
      coins.push(coin);
      Composite.add(world, coin);
    }

    // レバー UI 関連
    const leverArea = document.getElementById('lever-area');
    const leverKnob = document.getElementById('lever-knob');
    const pullAmountText = document.getElementById('pull-amount');
    const powerText = document.getElementById('power');

    const gravityInput = document.getElementById('gravity');
    const spawnBtn = document.getElementById('spawn-coin');
    const resetBtn = document.getElementById('reset');

    // レバーのストローク設定
    const leverTopY    = 40;               // つまみの一番上の位置（px, area基準）
    const leverBottomY = 200;              // つまみの一番下の位置
    const leverStroke  = leverBottomY - leverTopY;

    // 引き量（0〜1, 0=上(未チャージ), 1=最大下）
    let pullAmount = 0;
    let isDragging = false;
    let dragStartY = 0;

    // レバーつまみの初期位置
    function updateLeverKnobPosition() {
      const y = leverTopY + leverStroke * pullAmount;
      leverKnob.style.top = y + 'px';
    }
    pullAmount = 0;
    updateLeverKnobPosition();
    updateLeverLabel();

    function updateLeverLabel() {
      pullAmountText.textContent = pullAmount.toFixed(2);
      // バネのように非線形にしてもよいが、まずは線形でパワー計算
      const power = pullAmount; // 最大1.0
      powerText.textContent = power.toFixed(2);
    }

    // レバーを話した瞬間に発射
    function releaseLeverAndShoot() {
      const power = pullAmount;
      if (power <= 0.02) {
        // ほぼ引かれていないなら何もしない
        pullAmount = 0;
        updateLeverKnobPosition();
        updateLeverLabel();
        return;
      }

      // 発射位置にいるコインを探す：
      // 「ある範囲にいるオブジェクトをある方向に打ち出す」 → 発射位置周辺のコインを検索
      const launchRadius = COIN_RADIUS * 1.5; // 発射位置からの許容距離
      let targetCoin = null;
      for (const c of coins) {
        if (c.isSleeping) continue;
        const dx = c.position.x - LAUNCH_X;
        const dy = c.position.y - LAUNCH_Y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < launchRadius) {
          targetCoin = c;
          break;
        }
      }

      if (targetCoin) {
        // 発射方向：右上（棒が隙間から突き出すイメージ）
        // 角度は 30度〜45度くらいがそれっぽい
        const angle = -Math.PI / 4; // -45度
        const direction = Vector.create(Math.cos(angle), Math.sin(angle));

        // パワーから初速を計算（お好みで倍率調整可能）
        const baseSpeed = 25; // 調整用係数
        const speed = baseSpeed * power;

        const velocity = Vector.mult(direction, speed);

        Body.setVelocity(targetCoin, velocity);
      }

      // レバーをバネで戻したイメージにする（アニメっぽいが、ここでは即座に0に戻す）
      pullAmount = 0;
      updateLeverKnobPosition();
      updateLeverLabel();
    }

    // レバーのドラッグ処理
    leverKnob.addEventListener('mousedown', (e) => {
      isDragging = true;
      leverKnob.classList.add('dragging');
      dragStartY = e.clientY;
      e.preventDefault();
    });
    window.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const rect = leverArea.getBoundingClientRect();
      const localY = e.clientY - rect.top;

      // localY を leverTopY〜leverBottomY の範囲にクランプ
      const clampedY = Math.max(leverTopY, Math.min(leverBottomY, localY));
      pullAmount = (clampedY - leverTopY) / leverStroke;
      updateLeverKnobPosition();
      updateLeverLabel();
    });
    window.addEventListener('mouseup', (e) => {
      if (!isDragging) return;
      isDragging = false;
      leverKnob.classList.remove('dragging');
      // 指を離した瞬間に発射
      releaseLeverAndShoot();
    });

    // タッチ操作対応
    leverKnob.addEventListener('touchstart', (e) => {
      isDragging = true;
      leverKnob.classList.add('dragging');
      e.preventDefault();
    }, { passive: false });
    window.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const touch = e.touches[0];
      const rect = leverArea.getBoundingClientRect();
      const localY = touch.clientY - rect.top;
      const clampedY = Math.max(leverTopY, Math.min(leverBottomY, localY));
      pullAmount = (clampedY - leverTopY) / leverStroke;
      updateLeverKnobPosition();
      updateLeverLabel();
      e.preventDefault();
    }, { passive: false });
    window.addEventListener('touchend', (e) => {
      if (!isDragging) return;
      isDragging = false;
      leverKnob.classList.remove('dragging');
      releaseLeverAndShoot();
      e.preventDefault();
    }, { passive: false });

    // 重力変更
    gravityInput.addEventListener('input', (e) => {
      const g = parseFloat(e.target.value) || 0;
      engine.world.gravity.y = g;
    });

    // 10円を斜面上に追加
    spawnBtn.addEventListener('click', () => {
      spawnCoinOnSlope();
    });

    // リセット
    resetBtn.addEventListener('click', () => {
      // すべてのコイン削除
      for (const c of coins) {
        Composite.remove(world, c);
      }
      coins.length = 0;

      pullAmount = 0;
      updateLeverKnobPosition();
      updateLeverLabel();
    });

    // 最初に1枚だけ出しておく
    spawnCoinOnSlope();
  </script>
</body>
</html>
