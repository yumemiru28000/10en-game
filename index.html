<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>10円ゲーム マップ＋編集モード</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: sans-serif;
      overflow: hidden;
    }
    #uiTop {
      position: fixed;
      top: 4px;
      left: 4px;
      right: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
      pointer-events: none;
      font-size: 12px;
    }
    #uiLeft, #uiRight {
      pointer-events: auto;
      background: rgba(0,0,0,0.5);
      padding: 4px 8px;
      border-radius: 4px;
    }
    button {
      font-size: 11px;
      padding: 3px 6px;
      margin-right: 4px;
      background: #333;
      color: #eee;
      border: 1px solid #555;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
    input[type="number"], input[type="password"] {
      background: #222;
      border: 1px solid #555;
      color: #eee;
      font-size: 11px;
      padding: 2px 4px;
      border-radius: 3px;
      width: 60px;
    }
    #world {
      width: 100vw;
      height: 100vh;
    }
    #info {
      margin-top: 4px;
      font-size: 11px;
      color: #ccc;
    }
    #adminIndicator {
      font-weight: bold;
      color: #5cf;
    }
  </style>
</head>
<body>
  <div id="uiTop">
    <div id="uiLeft">
      <button id="dropCoinBtn">10円を落とす</button>
      重力:
      <input id="gravityInput" type="number" step="0.1" value="1.0" />
      <span id="coinInfo"></span>
      <div id="info">
        ・10円: 5.5g / 地球重力下<br>
        ・map.png を背景に使用
      </div>
    </div>
    <div id="uiRight">
      <span id="adminIndicator">運営モード: OFF</span>
      <button id="adminLoginBtn">運営ログイン</button>
      <input id="adminPassInput" type="password" placeholder="1122" />
      <br />
      <span style="font-size:11px;">棒の太さ(px):</span>
      <input id="barThicknessInput" type="number" min="2" max="80" value="12" />
      <button id="resetBarsBtn">棒リセット</button>
      <div style="font-size:11px; color:#ccc; margin-top:2px;">
        運営モード中:<br>
        キャンバス上で2点クリック → その間に棒を作成
      </div>
    </div>
  </div>

  <div id="world"></div>

  <!-- Matter.js -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
  <script>
    // ===============================
    //  基本設定 / 画像ロード
    // ===============================
    const base = "https://raw.githubusercontent.com/yumemiru28000/10en-game/main";
    const mapImageUrl = base + "/map.png";

    const Engine = Matter.Engine;
    const Render = Matter.Render;
    const Runner = Matter.Runner;
    const Bodies = Matter.Bodies;
    const Composite = Matter.Composite;
    const Body = Matter.Body;

    const engine = Engine.create();
    const world  = engine.world;

    // 地球の重力（Y 正方向が下）
    engine.world.gravity.y = 1.0; // UI から変更可

    const canvasWidth  = window.innerWidth;
    const canvasHeight = window.innerHeight;

    // 背景画像
    let mapImage = new Image();
    mapImage.src = mapImageUrl;

    const render = Render.create({
      element: document.getElementById('world'),
      engine: engine,
      options: {
        width: canvasWidth,
        height: canvasHeight,
        wireframes: false,
        background: '#000'  // 後でカスタム描画で map.png を貼る
      }
    });

    // Matter.js の標準描画をフックして背景画像を貼る
    const originalRenderWorld = Render.world;
    Render.world = function(renderInstance) {
      const ctx = renderInstance.context;
      const engine = renderInstance.engine;
      const options = renderInstance.options;

      // 背景を map.png で塗る
      if (mapImage.complete && mapImage.naturalWidth > 0) {
        ctx.save();
        ctx.setTransform(1, 0, 0, 1, 0, 0); // リセット
        // 画面全体にフィットさせて描画（単純な stretch）
        ctx.drawImage(mapImage, 0, 0, canvasWidth, canvasHeight);
        ctx.restore();
      } else {
        // 読み込み中は黒
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
      }

      // そのあとに通常のオブジェクト描画
      originalRenderWorld(renderInstance);
    };

    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

    // ===============================
    // 壁（画面端）
    // ===============================
    const wallThickness = 80;
    const walls = [
      Bodies.rectangle(canvasWidth / 2, -wallThickness / 2, canvasWidth, wallThickness, {
        isStatic: true, render: { visible: false }
      }),
      Bodies.rectangle(canvasWidth / 2, canvasHeight + wallThickness / 2, canvasWidth, wallThickness, {
        isStatic: true, render: { visible: false }
      }),
      Bodies.rectangle(-wallThickness / 2, canvasHeight / 2, wallThickness, canvasHeight, {
        isStatic: true, render: { visible: false }
      }),
      Bodies.rectangle(canvasWidth + wallThickness / 2, canvasHeight / 2, wallThickness, canvasHeight, {
        isStatic: true, render: { visible: false }
      })
    ];
    Composite.add(world, walls);

    // ===============================
    // 10円玉（5.5g）
    // ===============================
    const COIN_RADIUS = 11;
    const COIN_MASS   = 0.0055; // 5.5g

    const coins = [];

    function createCoin(x, y) {
      const coin = Bodies.circle(x, y, COIN_RADIUS, {
        mass: COIN_MASS,
        restitution: 0.1,      // あまり弾まない
        friction: 0.05,        // 動摩擦
        frictionStatic: 0.03,  // 静止摩擦（小さめ → 小さな斜面でも転がりやすい）
        frictionAir: 0.002,    // 空気抵抗（小さめにして減速しにくく）
        render: {
          fillStyle: '#cc8844',
          strokeStyle: '#ddbb77',
          lineWidth: 2
        }
      });
      return coin;
    }

    function dropCoin(x, y) {
      const cx = x ?? (canvasWidth / 2);
      const cy = y ?? 50;
      const c = createCoin(cx, cy);
      coins.push(c);
      Composite.add(world, c);
      updateCoinInfo();
      return c;
    }

    // 初期に1枚だけ上から落とす
    dropCoin(canvasWidth / 2, 50);

    function updateCoinInfo() {
      const info = document.getElementById('coinInfo');
      info.textContent = ` / 10円: ${coins.length}枚`;
    }

    // ===============================
    // 棒（バー）編集機能（運営モード）
    // ===============================
    let isAdmin = false;
    const adminPass = "1122";
    const customBars = []; // { body, x1,y1,x2,y2,thickness }

    const adminIndicator   = document.getElementById('adminIndicator');
    const adminLoginBtn    = document.getElementById('adminLoginBtn');
    const adminPassInput   = document.getElementById('adminPassInput');
    const barThicknessInput= document.getElementById('barThicknessInput');
    const resetBarsBtn     = document.getElementById('resetBarsBtn');

    adminLoginBtn.addEventListener('click', () => {
      if (!isAdmin) {
        const pass = adminPassInput.value.trim();
        if (pass === adminPass) {
          isAdmin = true;
          adminIndicator.textContent = "運営モード: ON";
          adminIndicator.style.color = "#5cf";
        } else {
          alert("パスワードが違います");
        }
      } else {
        isAdmin = false;
        adminIndicator.textContent = "運営モード: OFF";
        adminIndicator.style.color = "#aaa";
      }
    });

    resetBarsBtn.addEventListener('click', () => {
      customBars.forEach(b => Composite.remove(world, b.body));
      customBars.length = 0;
    });

    // 2 点クリックで棒を作る
    let pendingPointA = null; // {x,y} or null

    const worldElement = document.getElementById('world');
    worldElement.addEventListener('click', (e) => {
      if (!isAdmin) return;

      const rect = worldElement.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (!pendingPointA) {
        // 1点目
        pendingPointA = { x, y };
      } else {
        // 2点目 → 棒を生成
        const pointA = pendingPointA;
        const pointB = { x, y };
        pendingPointA = null;

        createBarFromPoints(pointA, pointB);
      }
    });

    function createBarFromPoints(p1, p2) {
      const thickness = Number(barThicknessInput.value) || 12;
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      const length = Math.sqrt(dx*dx + dy*dy);
      if (length < 5) return; // 短すぎるのは無視

      const centerX = (p1.x + p2.x) / 2;
      const centerY = (p1.y + p2.y) / 2;
      const angle = Math.atan2(dy, dx); // 水平右からの回転角

      const barBody = Bodies.rectangle(centerX, centerY, length, thickness, {
        isStatic: true,
        angle,
        render: { fillStyle: '#888' }
      });

      Composite.add(world, barBody);
      customBars.push({
        body: barBody,
        x1: p1.x, y1: p1.y,
        x2: p2.x, y2: p2.y,
        thickness
      });
    }

    // ===============================
    // UI: 10円落とす / 重力
    // ===============================
    const dropCoinBtn   = document.getElementById('dropCoinBtn');
    const gravityInput  = document.getElementById('gravityInput');

    dropCoinBtn.addEventListener('click', () => {
      dropCoin(canvasWidth / 2, 50);
    });

    gravityInput.addEventListener('input', (e) => {
      const g = parseFloat(e.target.value) || 0;
      engine.world.gravity.y = g;
    });

    // ===============================
    // リサイズ対応（シンプルにリロード）
    // ===============================
    window.addEventListener('resize', () => {
      // 本格対応するには再レイアウト・再生成が必要なので、
      // まずは手軽にリロードで対処
      // location.reload();
    });
  </script>
</body>
</html>
