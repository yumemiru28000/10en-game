<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>10円ゲーム 実験レバー付きシミュレーション</title>
  <style>
    body {
      margin: 0;
      background: #222;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #world {
      flex: 1;
      position: relative;
    }
    #ui {
      padding: 8px;
      background: #111;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #lever-container {
      position: absolute;
      left: 20px;
      bottom: 40px;
      width: 80px;
      height: 200px;
      border: 2px solid #555;
      border-radius: 8px;
      box-sizing: border-box;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 10px;
    }
    #lever-slot {
      width: 16px;
      height: 140px;
      background: #333;
      border-radius: 8px;
      position: relative;
      overflow: visible;
    }
    #lever-handle {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 24px;
      background: #cc4444;
      border-radius: 12px;
      cursor: grab;
      box-shadow: 0 0 4px rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      user-select: none;
    }
    #lever-power-bar {
      position: absolute;
      right: -14px;
      bottom: 0;
      width: 6px;
      height: 140px;
      background: #333;
      border-radius: 3px;
      overflow: hidden;
    }
    #lever-power-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 0%;
      background: linear-gradient(to top, #ff9900, #ffee00);
    }
    #lever-label {
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #ddd;
      text-shadow: 0 0 3px #000;
    }
    #info {
      font-size: 13px;
      opacity: 0.9;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="world">
    <!-- レバー UI -->
    <div id="lever-container">
      <div id="lever-slot">
        <div id="lever-label">レバー</div>
        <div id="lever-handle">引く</div>
        <div id="lever-power-bar">
          <div id="lever-power-fill"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="ui">
    <button id="spawn-coin">レバー位置に10円をセット</button>
    <button id="reset">すべてリセット</button>
    重力:
    <input id="gravity" type="number" step="0.1" value="1.0" style="width:60px;"> (下向き)
    <span id="info"></span>
  </div>

  <!-- Matter.js -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
  <script>
    const {
      Engine, Render, Runner, Bodies, Body, Composite, Events
    } = Matter;

    const engine = Engine.create();
    const world  = engine.world;
    engine.world.gravity.y = 1.0;

    const width  = 800;
    const height = 500;

    const render = Render.create({
      element: document.getElementById('world'),
      engine: engine,
      options: {
        width,
        height,
        wireframes: false,
        background: '#222'
      }
    });

    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

    // ==== 物理シーン構成 ==========================================
    const WALL_THICKNESS = 40;

    // 左右と下端の壁（縦箱イメージ）
    const leftWall = Bodies.rectangle(40, height/2, WALL_THICKNESS, height, {
      isStatic: true,
      render: { fillStyle: '#444' }
    });
    const rightWall = Bodies.rectangle(width - 40, height/2, WALL_THICKNESS, height, {
      isStatic: true,
      render: { fillStyle: '#444' }
    });
    const floor = Bodies.rectangle(width/2, height - 20, width - 80, WALL_THICKNESS, {
      isStatic: true,
      render: { fillStyle: '#555' },
      restitution: 0.2
    });

    // 発射エリアの床を少し斜めに（右上方向に飛び出させるための足場）
    const launchFloor = Bodies.rectangle(170, height - 100, 260, 14, {
      isStatic: true,
      angle: -Math.PI / 20, // わずかに右上がり
      render: { fillStyle: '#666' }
    });

    // 右側に斜め床：10円が転がっていく斜面
    const ramp = Bodies.rectangle(width - 220, height - 140, 320, 14, {
      isStatic: true,
      angle: -Math.PI / 8, // 右上がりの斜面
      render: { fillStyle: '#777' }
    });

    // 角の棒（10円がぶつかる障害物）
    const peg = Bodies.rectangle(width - 260, height - 220, 16, 80, {
      isStatic: true,
      angle: Math.PI / 10,
      render: { fillStyle: '#999' }
    });

    Composite.add(world, [leftWall, rightWall, floor, launchFloor, ramp, peg]);

    // ==== 10円玉の設定 ============================================
    const COIN_RADIUS = 11;
    const COIN_MASS   = 0.0055; // 5.5g
    let coins = [];

    function createCoin(x, y) {
      const coin = Bodies.circle(x, y, COIN_RADIUS, {
        mass: COIN_MASS,
        restitution: 0.3,
        friction: 0.05,
        frictionAir: 0.002,
        render: {
          fillStyle: '#cc8844',
          strokeStyle: '#ddbb77',
          lineWidth: 2
        }
      });
      coins.push(coin);
      Composite.add(world, coin);
      return coin;
    }

    // ==== レバー UI（物理ボディではない） ==========================
    const leverSlot   = document.getElementById('lever-slot');
    const leverHandle = document.getElementById('lever-handle');
    const powerFill   = document.getElementById('lever-power-fill');
    const infoSpan    = document.getElementById('info');

    // スロット内のレバーの移動範囲
    const slotRect = leverSlot.getBoundingClientRect();
    const slotTopOffset    = 20;   // スロット内の上限マージン
    const slotBottomOffset = 10;   // 下限マージン
    const leverMinY = slotTopOffset;                            // 一番上（= ほぼ 0 力）
    const leverMaxY = slotRect.height - slotBottomOffset - 24;  // 24=レバー高さ
    let dragging = false;
    let leverStrength = 0;  // 0.0〜1.0 (ばねの溜まり具合)

    // レバーの初期位置（下の方＝0）
    function setLeverByStrength(s) {
      leverStrength = Math.max(0, Math.min(1, s));
      const y = leverMinY + (leverMaxY - leverMinY) * leverStrength;
      leverHandle.style.top = y + 'px';
      powerFill.style.height = (leverStrength * 100) + '%';
    }
    setLeverByStrength(0);

    function onPointerDown(e) {
      dragging = true;
      leverHandle.style.cursor = 'grabbing';
      e.preventDefault();
    }
    function onPointerMove(e) {
      if (!dragging) return;
      const rect = leverSlot.getBoundingClientRect();
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const localY = clientY - rect.top - 12; // レバー中心を合わせる
      const clamped = Math.max(leverMinY, Math.min(leverMaxY, localY));
      // 上に動かすほど強くなるイメージ（上=1, 下=0）にしたいので反転
      const strength = 1 - (clamped - leverMinY) / (leverMaxY - leverMinY);
      setLeverByStrength(strength);
      updateInfo();
    }
    function onPointerUp(e) {
      if (!dragging) return;
      dragging = false;
      leverHandle.style.cursor = 'grab';
      // 離した瞬間に発射
      fireFromLever();
      // レバーはバネで戻るイメージ：アニメ的に0へ
      smoothResetLever();
    }

    leverHandle.addEventListener('mousedown', onPointerDown);
    window.addEventListener('mousemove', onPointerMove);
    window.addEventListener('mouseup', onPointerUp);

    leverHandle.addEventListener('touchstart', onPointerDown, {passive:false});
    window.addEventListener('touchmove', onPointerMove, {passive:false});
    window.addEventListener('touchend', onPointerUp);

    // ==== 発射判定エリア ==========================================
    // 「10円より小さいすき間から棒が飛び出る」イメージ：
    // レバー付近に小さな発射エリアを決め、その中にコインがあると発射される。
    const LAUNCH_AREA = {
      x: 150,        // 中心X（レバー近く）
      y: height - 120,
      w: 40,
      h: 40
    };

    // デバッグ可視化用に、透明な四角を追加（色は薄め）
    const launchAreaBody = Bodies.rectangle(
      LAUNCH_AREA.x,
      LAUNCH_AREA.y,
      LAUNCH_AREA.w,
      LAUNCH_AREA.h,
      {
        isStatic: true,
        isSensor: true,
        render: {
          fillStyle: 'rgba(0, 255, 0, 0.1)',
          strokeStyle: 'rgba(0, 255, 0, 0.6)',
          lineWidth: 1
        }
      }
    );
    Composite.add(world, launchAreaBody);

    // ==== レバーの力を 10円に伝える（打ち出し） =====================
    function fireFromLever() {
      const MIN_POWER = 2.0;   // ほとんど引いていないときの最低パワー
      const MAX_POWER = 18.0;  // フルパワー
      const s = leverStrength;
      if (s <= 0.02) return;   // ほぼゼロなら何もしない

      const power = MIN_POWER + (MAX_POWER - MIN_POWER) * s;

      // 発射方向：右上（斜め45度くらい）
      const angle = -Math.PI / 4;
      const vx = power * Math.cos(angle);
      const vy = power * Math.sin(angle);

      // 発射エリアにあるコインを探す
      coins.forEach(coin => {
        const { x, y } = coin.position;
        const inArea =
          x > (LAUNCH_AREA.x - LAUNCH_AREA.w / 2) &&
          x < (LAUNCH_AREA.x + LAUNCH_AREA.w / 2) &&
          y > (LAUNCH_AREA.y - LAUNCH_AREA.h / 2) &&
          y < (LAUNCH_AREA.y + LAUNCH_AREA.h / 2);

        if (inArea) {
          Body.setVelocity(coin, { x: vx, y: vy });
        }
      });
    }

    // レバーをゆっくり戻すアニメーション
    function smoothResetLever() {
      const start = leverStrength;
      const duration = 200; // ms
      const startTime = performance.now();

      function step(now) {
        const t = (now - startTime) / duration;
        if (t >= 1) {
          setLeverByStrength(0);
          updateInfo();
          return;
        }
        const eased = start * (1 - t*t); // 簡単な加速減速
        setLeverByStrength(eased);
        updateInfo();
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // ==== UI ボタンなど =============================================
    document.getElementById('gravity').addEventListener('input', (e) => {
      const g = parseFloat(e.target.value) || 0;
      engine.world.gravity.y = g;
    });

    document.getElementById('spawn-coin').addEventListener('click', () => {
      // レバー側の発射エリアに10円をセット
      createCoin(LAUNCH_AREA.x, LAUNCH_AREA.y + 5);
    });

    document.getElementById('reset').addEventListener('click', () => {
      coins.forEach(c => Composite.remove(world, c));
      coins = [];
      setLeverByStrength(0);
      updateInfo();
    });

    function updateInfo() {
      infoSpan.textContent = `レバー引き具合: ${(leverStrength * 100).toFixed(0)}%`;
    }
    updateInfo();

    // ==== 補足：イベントなど ========================================

    // コインが画面外に行き過ぎたら削除
    Events.on(engine, 'afterUpdate', () => {
      const margin = 200;
      coins = coins.filter(c => {
        const { x, y } = c.position;
        const alive = (x > -margin && x < width + margin && y > -margin && y < height + margin);
        if (!alive) Composite.remove(world, c);
        return alive;
      });
    });
  </script>
</body>
</html>
