<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>10円ゲーム 統合版（レバー＋map背景＋編集棒）</title>
  <style>
    body {
      margin: 0;
      background: #222;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow: hidden;
    }

    #uiPanel {
      width: 200px;
      background: #111;
      border-right: 1px solid #333;
      padding: 8px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }

    #leverArea {
      position: relative;
      width: 160px;
      height: 140px;
      margin: 0 auto;
      border: 1px solid #444;
      background: #181818;
      border-radius: 4px;
      touch-action: none;
    }

    /* レバー UI （「L」の形） */
    #lever {
      position: absolute;
      width: 12px;
      height: 80px;
      background: #ccc;
      left: 50%;
      bottom: 15px;
      transform-origin: 50% 100%;
      transform: translateX(-50%) rotate(0deg);
      cursor: grab;
    }
    #lever:active {
      cursor: grabbing;
    }
    #lever::after {
      content: "";
      position: absolute;
      width: 30px;
      height: 12px;
      background: #ccc;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
    }

    #leverLabel {
      position: absolute;
      left: 4px;
      bottom: 4px;
      font-size: 10px;
      color: #aaa;
    }

    #leverInfo {
      font-size: 12px;
      line-height: 1.5;
    }

    #world {
      flex: 1;
      position: relative;
    }

    /* 背景画像（map.png） */
    #worldBg {
      position: absolute;
      inset: 0;
      background-size: contain;   /* 画像全体が見えるように */
      background-position: center;
      background-repeat: no-repeat;
      pointer-events: none;       /* 画像がマウス操作をブロックしないように */
      z-index: 0;
    }
    #worldCanvasContainer {
      position: absolute;
      inset: 0;
      z-index: 1;
    }

    button {
      font-size: 12px;
      padding: 4px 8px;
      background: #333;
      color: #eee;
      border: 1px solid #555;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
    input[type="number"],
    input[type="password"],
    input[type="text"] {
      width: 70px;
      background: #222;
      border: 1px solid #555;
      color: #eee;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 12px;
    }
    label {
      display: block;
      margin-top: 4px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="uiPanel">
    <!-- レバー UI -->
    <div id="leverArea">
      <div id="lever"></div>
      <div id="leverLabel">レバー</div>
    </div>
    <div id="leverInfo">
      角度: <span id="angleText">0</span>°<br>
      引き具合(0～1): <span id="powerText">0.00</span>
    </div>

    <!-- 重力・コイン操作 -->
    <div>
      <label>
        重力Y:
        <input id="gravity" type="number" step="0.1" value="1.0">
      </label>
      <button id="addCoin">10円を置く</button>
      <button id="resetWorld">コインリセット</button>
    </div>

    <!-- 棒（レール）編集・運営モード -->
    <div style="border-top:1px solid #333; padding-top:4px; margin-top:4px;">
      <div style="font-size:11px; color:#ccc; margin-bottom:4px;">運営モード</div>
      <label>
        パスワード:
        <input id="adminPass" type="password" placeholder="1122">
      </label>
      <button id="toggleAdmin">運営ON/OFF</button>
      <div>状態: <span id="adminState">OFF</span></div>

      <div style="margin-top:6px;">
        <label>
          棒の太さ(px):
          <input id="barThickness" type="number" min="2" max="40" value="10">
        </label>
        <button id="resetBars">棒リセット</button>
      </div>
      <div style="font-size:10px; color:#aaa; margin-top:4px;">
        運営ONのとき:<br>
        ・フィールド上をクリック→点1<br>
        ・次にクリック→点2（棒追加）<br>
        これを繰り返してレール作成
      </div>
    </div>

  </div>

  <div id="world">
    <!-- 背景画像として map.png を貼る -->
    <div id="worldBg"></div>
    <!-- Matter.js のキャンバスを上に重ねる -->
    <div id="worldCanvasContainer"></div>
  </div>

  <!-- Matter.js -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
  <script>
    // ============================================================
    // レバー／発射／斜面などの設定用定数（既存＋拡張）
    // ============================================================

    // レバーの「重さ」カーブ（大きいほど最後が急に重い）
    const REBA_HEAVINESS_EXPONENT = 3.0;

    // レバー最大角度
    const REBA_MAX_ANGLE_DEG = 90;

    // 打ち出し方向（度） 0=右, -90=上
    const REBA_LAUNCH_ANGLE_DEG = -45;

    // 打ち出しの最大速度
    const REBA_MAX_LAUNCH_SPEED = 30;

    // ドラッグ感度
    const REBA_DRAG_SENSITIVITY = 0.5;

    // 発射範囲
    const REBA_LAUNCH_RADIUS = 30;

    // 10円玉（5.5g）のパラメータ
    const COIN_RADIUS = 11;
    const COIN_MASS   = 0.0055;

    // 「小さい斜面でも転がるか」テスト用の床角度（ラジアン）
    const REBA_TEST_SLOPE_ANGLE = 0.05;

    // 発射台中心座標（フィールド内の位置）
    const REBA_LAUNCH_BASE_X = 220;
    const REBA_LAUNCH_BASE_Y = 400;

    // 運営モード用パスワード
    const ADMIN_PASSWORD = "1122";

    // ============================================================
    // Matter.js セットアップ
    // ============================================================
    const Engine = Matter.Engine;
    const Render = Matter.Render;
    const Runner = Matter.Runner;
    const Bodies = Matter.Bodies;
    const Composite = Matter.Composite;
    const Body = Matter.Body;

    const engine = Engine.create();
    const world  = engine.world;
    engine.world.gravity.y = 1.0; // 地球重力のイメージ（値は実験で調整）

    const canvasWidth  = window.innerWidth - 200; // UIパネル分を差し引き
    const canvasHeight = window.innerHeight;

    // 背景画像を設定
    const worldBg = document.getElementById('worldBg');
    worldBg.style.backgroundImage =
      "url('https://raw.githubusercontent.com/yumemiru28000/10en-game/main/map.png')";

    const render = Render.create({
      element: document.getElementById('worldCanvasContainer'),
      engine: engine,
      options: {
        width: canvasWidth,
        height: canvasHeight,
        wireframes: false,
        background: 'transparent' // 背景は map.png に任せる
      }
    });
    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

    // ============================================================
    // 壁や既存の斜面など
    // ============================================================
    const thickness = 40;

    const leftWall = Bodies.rectangle(20, canvasHeight / 2, thickness, canvasHeight, {
      isStatic: true,
      render: { fillStyle: 'rgba(80,80,80,0.5)' }
    });
    const rightWall = Bodies.rectangle(canvasWidth - 20, canvasHeight / 2, thickness, canvasHeight, {
      isStatic: true,
      render: { fillStyle: 'rgba(80,80,80,0.5)' }
    });
    const ceiling = Bodies.rectangle(canvasWidth / 2, 20, canvasWidth, thickness, {
      isStatic: true,
      render: { fillStyle: 'rgba(80,80,80,0.5)' }
    });

    // 右下の大きめ斜面 & 角の棒（前回のものを踏襲）
    const bigFloorAngle = -Math.PI / 8;
    const floorLength = 500;

    const slopedFloor = Bodies.rectangle(
      canvasWidth - 260,
      canvasHeight - 60,
      floorLength,
      20,
      {
        isStatic: true,
        angle: bigFloorAngle,
        render: { fillStyle: 'rgba(140,140,140,0.7)' }
      }
    );

    const cornerPost = Bodies.rectangle(
      canvasWidth - 350,
      canvasHeight - 150,
      20,
      80,
      {
        isStatic: true,
        render: { fillStyle: 'rgba(180,180,180,0.7)' }
      }
    );

    // 小さな斜面（テスト用）
    const gentleSlope = Bodies.rectangle(
      canvasWidth / 2,
      canvasHeight / 2 + 80,
      350,
      10,
      {
        isStatic: true,
        angle: REBA_TEST_SLOPE_ANGLE,
        render: { fillStyle: 'rgba(120,120,120,0.7)' }
      }
    );

    Composite.add(world, [leftWall, rightWall, ceiling, slopedFloor, cornerPost, gentleSlope]);

    // ============================================================
    // 10円玉
    // ============================================================
    const coins = [];

    function createCoin(x, y) {
      return Bodies.circle(x, y, COIN_RADIUS, {
        mass: COIN_MASS,
        restitution: 0.2,   // 弾みすぎないよう少し低め
        friction: 0.02,     // 動摩擦はかなり小さく
        frictionStatic: 0.01, // 静止摩擦も小さめ → ほんの斜面でも転がりやすい
        frictionAir: 0.0005,  // 空気抵抗も弱め
        render: {
          fillStyle: '#cc8844',
          strokeStyle: '#ddbb77',
          lineWidth: 2
        }
      });
    }

    function addCoinAt(x, y) {
      const c = createCoin(x, y);
      coins.push(c);
      Composite.add(world, c);
      return c;
    }

    // 初期の10円（発射台付近に 1 枚）
    addCoinAt(REBA_LAUNCH_BASE_X, REBA_LAUNCH_BASE_Y);

    // ============================================================
    // 発射台のスリットのイメージ
    // ============================================================
    const blockThickness = 20;
    const baseBlockWidth = 80;

    const slotUpper = Bodies.rectangle(
      REBA_LAUNCH_BASE_X,
      REBA_LAUNCH_BASE_Y - COIN_RADIUS - 5,
      baseBlockWidth,
      blockThickness,
      { isStatic: true, render: { fillStyle: 'rgba(100,100,100,0.7)' } }
    );
    const slotLower = Bodies.rectangle(
      REBA_LAUNCH_BASE_X,
      REBA_LAUNCH_BASE_Y + COIN_RADIUS + 5,
      baseBlockWidth,
      blockThickness,
      { isStatic: true, render: { fillStyle: 'rgba(100,100,100,0.7)' } }
    );
    const slotLeftWall = Bodies.rectangle(
      REBA_LAUNCH_BASE_X - baseBlockWidth / 2 + 10,
      REBA_LAUNCH_BASE_Y,
      20,
      COIN_RADIUS * 4,
      { isStatic: true, render: { fillStyle: 'rgba(100,100,100,0.7)' } }
    );

    Composite.add(world, [slotUpper, slotLower, slotLeftWall]);

    // ============================================================
    // レバー UI ロジック（既存）
    // ============================================================
    const leverEl = document.getElementById('lever');
    const angleTextEl = document.getElementById('angleText');
    const powerTextEl = document.getElementById('powerText');
    const gravityInput = document.getElementById('gravity');
    const addCoinBtn = document.getElementById('addCoin');
    const resetWorldBtn = document.getElementById('resetWorld');

    let leverAngleDeg = 0;
    const maxAngleDeg = REBA_MAX_ANGLE_DEG;

    let isDraggingLever = false;
    let dragStartY = 0;
    let dragStartAngle = 0;

    function calcPullPower() {
      const normalized = leverAngleDeg / maxAngleDeg;
      return Math.pow(normalized, REBA_HEAVINESS_EXPONENT);
    }

    function updateLeverVisual() {
      leverEl.style.transform = `translateX(-50%) rotate(${leverAngleDeg}deg)`;
      angleTextEl.textContent = leverAngleDeg.toFixed(1);
      powerTextEl.textContent = calcPullPower().toFixed(2);
    }

    function getLaunchDirection() {
      const rad = REBA_LAUNCH_ANGLE_DEG * Math.PI / 180;
      return {
        x: Math.cos(rad),
        y: Math.sin(rad)
      };
    }

    function getLaunchPower() {
      const pullPower = calcPullPower();
      return pullPower * REBA_MAX_LAUNCH_SPEED;
    }

    function releaseLeverAndLaunch() {
      const power = getLaunchPower();
      if (power <= 0.1) {
        leverAngleDeg = 0;
        updateLeverVisual();
        return;
      }
      const dir = getLaunchDirection();

      coins.forEach(c => {
        const dx = c.position.x - REBA_LAUNCH_BASE_X;
        const dy = c.position.y - REBA_LAUNCH_BASE_Y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < REBA_LAUNCH_RADIUS) {
          Body.setVelocity(c, {
            x: dir.x * power,
            y: dir.y * power
          });
        }
      });

      leverAngleDeg = 0;
      updateLeverVisual();
    }

    function startDragLever(startY) {
      isDraggingLever = true;
      dragStartY = startY;
      dragStartAngle = leverAngleDeg;
    }

    function moveDragLever(currentY) {
      if (!isDraggingLever) return;
      const dy = currentY - dragStartY;
      let newAngle = dragStartAngle + dy * REBA_DRAG_SENSITIVITY;
      newAngle = Math.max(0, Math.min(maxAngleDeg, newAngle));
      leverAngleDeg = newAngle;
      updateLeverVisual();
    }

    function endDragLever() {
      if (!isDraggingLever) return;
      isDraggingLever = false;
      releaseLeverAndLaunch();
    }

    // マウス
    leverEl.addEventListener('mousedown', (e) => {
      e.preventDefault();
      startDragLever(e.clientY);
    });
    window.addEventListener('mousemove', (e) => {
      if (!isDraggingLever) return;
      e.preventDefault();
      moveDragLever(e.clientY);
    });
    window.addEventListener('mouseup', (e) => {
      if (!isDraggingLever) return;
      e.preventDefault();
      endDragLever();
    });

    // タッチ
    leverEl.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const t = e.touches[0];
      startDragLever(t.clientY);
    }, { passive: false });
    window.addEventListener('touchmove', (e) => {
      if (!isDraggingLever) return;
      e.preventDefault();
      const t = e.touches[0];
      moveDragLever(t.clientY);
    }, { passive: false });
    window.addEventListener('touchend', (e) => {
      if (!isDraggingLever) return;
      e.preventDefault();
      endDragLever();
    }, { passive: false });

    updateLeverVisual();

    // ============================================================
    // 運営モード & 棒（レール）編集機能
    // ============================================================
    const adminPassInput = document.getElementById('adminPass');
    const toggleAdminBtn = document.getElementById('toggleAdmin');
    const adminStateLabel = document.getElementById('adminState');
    const barThicknessInput = document.getElementById('barThickness');
    const resetBarsBtn = document.getElementById('resetBars');

    let isAdminMode = false;
    let pendingPoint = null; // 始点が指定済みなら {x,y} を持つ

    const dynamicBars = []; // ここにユーザーが作った棒（Bodies.rectangle）を保存

    function setAdminMode(on) {
      isAdminMode = on;
      adminStateLabel.textContent = on ? "ON" : "OFF";
    }

    toggleAdminBtn.addEventListener('click', () => {
      if (!isAdminMode) {
        // ON にするときはパスワード確認
        if (adminPassInput.value === ADMIN_PASSWORD) {
          setAdminMode(true);
        } else {
          alert("パスワードが違います");
        }
      } else {
        // OFF にする
        setAdminMode(false);
        pendingPoint = null;
      }
    });

    // フィールド上クリックで点を指定
    const worldDiv = document.getElementById('worldCanvasContainer');
    worldDiv.addEventListener('mousedown', (e) => {
      if (!isAdminMode) return;

      // worldCanvasContainer の左上基準の座標に変換
      const rect = worldDiv.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (!pendingPoint) {
        // 始点をセット
        pendingPoint = { x, y };
      } else {
        // 終点をセットして棒を作る
        const p1 = pendingPoint;
        const p2 = { x, y };
        pendingPoint = null;

        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        if (length < 5) return; // あまりに短いのは無視

        const angle = Math.atan2(dy, dx);
        const thicknessBar = parseFloat(barThicknessInput.value) || 10;

        const bar = Bodies.rectangle(
          (p1.x + p2.x) / 2,
          (p1.y + p2.y) / 2,
          length,
          thicknessBar,
          {
            isStatic: true,
            angle: angle,
            render: { fillStyle: 'rgba(0, 200, 255, 0.8)' }
          }
        );
        dynamicBars.push(bar);
        Composite.add(world, bar);
      }
    });

    resetBarsBtn.addEventListener('click', () => {
      dynamicBars.forEach(b => Composite.remove(world, b));
      dynamicBars.length = 0;
      pendingPoint = null;
    });

    // ============================================================
    // 重力・コイン UI
    // ============================================================
    gravityInput.addEventListener('input', (e) => {
      const g = parseFloat(e.target.value) || 0;
      engine.world.gravity.y = g;
    });

    addCoinBtn.addEventListener('click', () => {
      const x = REBA_LAUNCH_BASE_X + (Math.random() * 20 - 10);
      const y = REBA_LAUNCH_BASE_Y + (Math.random() * 10 - 5);
      addCoinAt(x, y);
    });

    resetWorldBtn.addEventListener('click', () => {
      coins.forEach(c => Composite.remove(world, c));
      coins.length = 0;
      addCoinAt(REBA_LAUNCH_BASE_X, REBA_LAUNCH_BASE_Y);
      leverAngleDeg = 0;
      updateLeverVisual();
    });

    // リサイズ時（簡易対応）
    window.addEventListener('resize', () => {
      // 本格的には再レイアウトが必要。とりあえず注意だけ。
      // 必要なら location.reload() を有効化してください。
      // location.reload();
    });
  </script>
</body>
</html>
