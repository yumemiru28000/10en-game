<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>10円ゲーム + マップ + 運営モード</title>
  <style>
    body {
      margin: 0;
      background: #222;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow: hidden;
    }

    #uiPanel {
      width: 190px;
      background: #111;
      border-right: 1px solid #333;
      padding: 8px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }

    #leverArea {
      position: relative;
      width: 160px;
      height: 140px;
      margin: 0 auto;
      border: 1px solid #444;
      background: #181818;
      border-radius: 4px;
      touch-action: none;
    }

    #lever {
      position: absolute;
      width: 12px;
      height: 80px;
      background: #ccc;
      left: 50%;
      bottom: 15px;
      transform-origin: 50% 100%;
      transform: translateX(-50%) rotate(0deg);
      cursor: grab;
    }
    #lever:active {
      cursor: grabbing;
    }
    #lever::after {
      content: "";
      position: absolute;
      width: 30px;
      height: 12px;
      background: #ccc;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
    }

    #leverLabel {
      position: absolute;
      left: 4px;
      bottom: 4px;
      font-size: 10px;
      color: #aaa;
    }

    #leverInfo {
      font-size: 12px;
      line-height: 1.5;
    }

    #world {
      flex: 1;
    }

    button {
      font-size: 12px;
      padding: 4px 8px;
      background: #333;
      color: #eee;
      border: 1px solid #555;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
    input[type="number"], input[type="password"] {
      width: 70px;
      background: #222;
      border: 1px solid #555;
      color: #eee;
      padding: 2px 4px;
      border-radius: 3px;
    }
    label {
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="uiPanel">
    <div id="leverArea">
      <div id="lever"></div>
      <div id="leverLabel">レバー</div>
    </div>
    <div id="leverInfo">
      角度: <span id="angleText">0</span>°<br>
      引き具合(0～1): <span id="powerText">0.00</span>
    </div>
    <div>
      重力:
      <input id="gravity" type="number" step="0.1" value="1.0">
    </div>
    <div>
      <button id="addCoin">10円を置く</button>
      <button id="resetWorld">リセット</button>
    </div>
    <div style="font-size:11px; color:#aaa; margin-top:4px;">
      操作:<br>
      ・レバーをドラッグで時計回り最大90°<br>
      ・離すと、近くの10円を指定方向へ発射
    </div>
    <hr style="border-color:#333;">
    <div style="font-size:11px;">
      <b>運営モード</b><br>
      パスワード: <input id="adminPass" type="password" value="">
      <button id="adminToggle">OFF</button><br>
      <span id="adminStatus" style="color:#a55;">運営モード: OFF</span><br>
      （ON 中はキャンバスクリックで棒を追加）
    </div>
  </div>

  <div id="world"></div>

  <!-- Matter.js -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
  <script>
    // ============================================================
    // 設定用定数
    // ============================================================
    const base = "https://raw.githubusercontent.com/yumemiru28000/10en-game/main";

    // レバーの重さ（引きにくさ）
    const REBA_HEAVINESS_EXPONENT = 3.0;
    const REBA_MAX_ANGLE_DEG = 90;
    const REBA_LAUNCH_ANGLE_DEG = -45;
    const REBA_MAX_LAUNCH_SPEED = 30;
    const REBA_DRAG_SENSITIVITY = 0.5;
    const REBA_LAUNCH_RADIUS = 30;

    const COIN_RADIUS = 11;
    const COIN_MASS = 0.0055;

    const REBA_TEST_SLOPE_ANGLE = 0.05;

    const REBA_LAUNCH_BASE_X = 260;
    const REBA_LAUNCH_BASE_Y = 420;

    // 管理用パスワード
    const ADMIN_PASSWORD = "1122";

    // ============================================================
    // 画像読み込みユーティリティ
    // ============================================================
    const images = {};
    function loadImage(id, src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          images[id] = img;
          resolve(img);
        };
        img.onerror = reject;
        img.src = src;
      });
    }

    // ============================================================
    // Matter.js 基本セットアップ
    // ============================================================
    const Engine = Matter.Engine;
    const Render = Matter.Render;
    const Runner = Matter.Runner;
    const Bodies = Matter.Bodies;
    const Composite = Matter.Composite;
    const Body = Matter.Body;

    const engine = Engine.create();
    const world = engine.world;
    engine.world.gravity.y = 1.0;

    const canvasWidth = window.innerWidth - 190;
    const canvasHeight = window.innerHeight;

    const render = Render.create({
      element: document.getElementById('world'),
      engine: engine,
      options: {
        width: canvasWidth,
        height: canvasHeight,
        wireframes: false,
        background: '#222'
      }
    });

    // Matter.js が内部で使っている canvas を取得し、背景に map.png を描画する
    const renderCanvas = render.canvas;
    const renderContext = render.context;

    // オリジナルの render 関数をラップして背景画像を描画
    const originalRenderWorld = Render.world;
    Render.world = function(engine) {
      const world = engine.world;
      const ctx = renderContext;
      const canvas = renderCanvas;

      // まず背景クリア
      ctx.fillStyle = "#222";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // map.png があれば背景として描画
      const mapImg = images["map"];
      if (mapImg) {
        // キャンバス全体にフィットさせる簡易版（縦横比は無視）
        ctx.drawImage(mapImg, 0, 0, canvas.width, canvas.height);
      }

      // その上に Matter.js のオブジェクト描画
      originalRenderWorld.call(Render, engine);
    };

    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

    // ============================================================
    // 壁 / 地面 / 斜面
    // ============================================================
    const thickness = 40;
    const leftWall = Bodies.rectangle(20, canvasHeight / 2, thickness, canvasHeight, {
      isStatic: true,
      render: { fillStyle: "rgba(50,50,50,0.6)" }
    });
    const rightWall = Bodies.rectangle(canvasWidth - 20, canvasHeight / 2, thickness, canvasHeight, {
      isStatic: true,
      render: { fillStyle: "rgba(50,50,50,0.6)" }
    });
    const ceiling = Bodies.rectangle(canvasWidth / 2, 20, canvasWidth, thickness, {
      isStatic: true,
      render: { fillStyle: "rgba(50,50,50,0.6)" }
    });

    const floorAngle = -Math.PI / 8;
    const floorLength = 500;
    const slopedFloor = Bodies.rectangle(
      canvasWidth - 260,
      canvasHeight - 60,
      floorLength,
      20,
      {
        isStatic: true,
        angle: floorAngle,
        render: { fillStyle: "rgba(100,100,100,0.7)" }
      }
    );

    const cornerPost = Bodies.rectangle(
      canvasWidth - 350,
      canvasHeight - 150,
      20,
      80,
      {
        isStatic: true,
        render: { fillStyle: "rgba(150,150,150,0.8)" }
      }
    );

    const gentleSlope = Bodies.rectangle(
      canvasWidth / 2,
      canvasHeight / 2 + 80,
      350,
      10,
      {
        isStatic: true,
        angle: REBA_TEST_SLOPE_ANGLE,
        render: { fillStyle: "rgba(90,90,90,0.7)" }
      }
    );

    Composite.add(world, [leftWall, rightWall, ceiling, slopedFloor, cornerPost, gentleSlope]);

    // ============================================================
    // 棒（運営モードで追加できる）
    // ============================================================
    const BAR_STORAGE_KEY = "10en-game-bars-v1";
    const bars = [];

    function createBar(x, y, width = 120, height = 10, angleDeg = 0) {
      const bar = Bodies.rectangle(x, y, width, height, {
        isStatic: true,
        angle: angleDeg * Math.PI / 180,
        render: { fillStyle: "rgba(200,200,200,0.9)" }
      });
      bars.push({
        body: bar,
        x, y, width, height, angleDeg
      });
      Composite.add(world, bar);
      saveBars();
    }

    function saveBars() {
      const data = bars.map(b => ({
        x: b.body.position.x,
        y: b.body.position.y,
        width: b.width,
        height: b.height,
        angleDeg: b.angleDeg
      }));
      localStorage.setItem(BAR_STORAGE_KEY, JSON.stringify(data));
    }

    function loadBars() {
      const json = localStorage.getItem(BAR_STORAGE_KEY);
      if (!json) return;
      try {
        const arr = JSON.parse(json);
        arr.forEach(b => {
          const bar = Bodies.rectangle(
            b.x,
            b.y,
            b.width,
            b.height,
            {
              isStatic: true,
              angle: b.angleDeg * Math.PI / 180,
              render: { fillStyle: "rgba(200,200,200,0.9)" }
            }
          );
          bars.push({ body: bar, ...b });
          Composite.add(world, bar);
        });
      } catch (e) {
        console.error("Failed to load bars", e);
      }
    }

    loadBars();

    // ============================================================
    // 10円玉（摩擦を小さくしてよく転がるように）
    // ============================================================
    const coins = [];

    function createCoin(x, y) {
      return Bodies.circle(x, y, COIN_RADIUS, {
        mass: COIN_MASS,
        restitution: 0.3,
        friction: 0.02,        // 小さめ
        frictionStatic: 0.05,  // かなり小さめ -> 斜面で止まりにくい
        frictionAir: 0.0015,
        render: {
          fillStyle: "#cc8844",
          strokeStyle: "#ddbb77",
          lineWidth: 2
        }
      });
    }

    function addCoinAt(x, y) {
      const c = createCoin(x, y);
      coins.push(c);
      Composite.add(world, c);
      return c;
    }

    addCoinAt(REBA_LAUNCH_BASE_X, REBA_LAUNCH_BASE_Y);

    // 発射台の見た目
    const blockThickness = 20;
    const baseBlockWidth = 80;

    const slotUpper = Bodies.rectangle(
      REBA_LAUNCH_BASE_X,
      REBA_LAUNCH_BASE_Y - COIN_RADIUS - 5,
      baseBlockWidth,
      blockThickness,
      { isStatic: true, render: { fillStyle: "rgba(80,80,80,0.7)" } }
    );
    const slotLower = Bodies.rectangle(
      REBA_LAUNCH_BASE_X,
      REBA_LAUNCH_BASE_Y + COIN_RADIUS + 5,
      baseBlockWidth,
      blockThickness,
      { isStatic: true, render: { fillStyle: "rgba(80,80,80,0.7)" } }
    );
    const slotLeftWall = Bodies.rectangle(
      REBA_LAUNCH_BASE_X - baseBlockWidth / 2 + 10,
      REBA_LAUNCH_BASE_Y,
      20,
      COIN_RADIUS * 4,
      { isStatic: true, render: { fillStyle: "rgba(80,80,80,0.7)" } }
    );
    Composite.add(world, [slotUpper, slotLower, slotLeftWall]);

    // ============================================================
    // レバー UI
    // ============================================================
    const leverEl = document.getElementById("lever");
    const angleTextEl = document.getElementById("angleText");
    const powerTextEl = document.getElementById("powerText");
    const gravityInput = document.getElementById("gravity");
    const addCoinBtn = document.getElementById("addCoin");
    const resetWorldBtn = document.getElementById("resetWorld");

    let leverAngleDeg = 0;
    let isDraggingLever = false;
    let dragStartY = 0;
    let dragStartAngle = 0;

    function calcPullPower() {
      const normalized = leverAngleDeg / REBA_MAX_ANGLE_DEG;
      return Math.pow(normalized, REBA_HEAVINESS_EXPONENT);
    }

    function updateLeverVisual() {
      leverEl.style.transform = `translateX(-50%) rotate(${leverAngleDeg}deg)`;
      angleTextEl.textContent = leverAngleDeg.toFixed(1);
      powerTextEl.textContent = calcPullPower().toFixed(2);
    }

    function getLaunchDirection() {
      const rad = REBA_LAUNCH_ANGLE_DEG * Math.PI / 180;
      return { x: Math.cos(rad), y: Math.sin(rad) };
    }

    function getLaunchPower() {
      return calcPullPower() * REBA_MAX_LAUNCH_SPEED;
    }

    function releaseLeverAndLaunch() {
      const power = getLaunchPower();
      if (power <= 0.1) {
        leverAngleDeg = 0;
        updateLeverVisual();
        return;
      }
      const dir = getLaunchDirection();
      coins.forEach(c => {
        const dx = c.position.x - REBA_LAUNCH_BASE_X;
        const dy = c.position.y - REBA_LAUNCH_BASE_Y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < REBA_LAUNCH_RADIUS) {
          Body.setVelocity(c, {
            x: dir.x * power,
            y: dir.y * power
          });
        }
      });
      leverAngleDeg = 0;
      updateLeverVisual();
    }

    function startDragLever(y) {
      isDraggingLever = true;
      dragStartY = y;
      dragStartAngle = leverAngleDeg;
    }

    function moveDragLever(y) {
      if (!isDraggingLever) return;
      const dy = y - dragStartY;
      let newAngle = dragStartAngle + dy * REBA_DRAG_SENSITIVITY;
      newAngle = Math.max(0, Math.min(REBA_MAX_ANGLE_DEG, newAngle));
      leverAngleDeg = newAngle;
      updateLeverVisual();
    }

    function endDragLever() {
      if (!isDraggingLever) return;
      isDraggingLever = false;
      releaseLeverAndLaunch();
    }

    // マウス
    leverEl.addEventListener("mousedown", (e) => {
      e.preventDefault();
      startDragLever(e.clientY);
    });
    window.addEventListener("mousemove", (e) => {
      if (!isDraggingLever) return;
      e.preventDefault();
      moveDragLever(e.clientY);
    });
    window.addEventListener("mouseup", (e) => {
      if (!isDraggingLever) return;
      e.preventDefault();
      endDragLever();
    });

    // タッチ
    leverEl.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const t = e.touches[0];
      startDragLever(t.clientY);
    }, { passive: false });
    window.addEventListener("touchmove", (e) => {
      if (!isDraggingLever) return;
      e.preventDefault();
      const t = e.touches[0];
      moveDragLever(t.clientY);
    }, { passive: false });
    window.addEventListener("touchend", (e) => {
      if (!isDraggingLever) return;
      e.preventDefault();
      endDragLever();
    }, { passive: false });

    updateLeverVisual();

    // ============================================================
    // 運営モード UI & ロジック（棒追加）
    // ============================================================
    const adminPassInput = document.getElementById("adminPass");
    const adminToggleBtn = document.getElementById("adminToggle");
    const adminStatusEl = document.getElementById("adminStatus");

    let adminMode = false;

    function updateAdminUI() {
      adminToggleBtn.textContent = adminMode ? "ON" : "OFF";
      adminStatusEl.textContent = "運営モード: " + (adminMode ? "ON" : "OFF");
      adminStatusEl.style.color = adminMode ? "#5fa" : "#a55";
    }

    adminToggleBtn.addEventListener("click", () => {
      if (!adminMode) {
        const inputPass = adminPassInput.value;
        if (inputPass === ADMIN_PASSWORD) {
          adminMode = true;
        } else {
          alert("パスワードが違います");
        }
      } else {
        adminMode = false;
      }
      updateAdminUI();
    });

    // キャンバスクリックで棒追加（運営モード時のみ）
    renderCanvas.addEventListener("mousedown", (e) => {
      if (!adminMode) return;
      const rect = renderCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      // 標準サイズ・角度0度の棒を追加（必要ならここをパラメータ化可能）
      createBar(x, y, 120, 10, 0);
    });

    updateAdminUI();

    // ============================================================
    // UI: 重力・10円追加・リセット
    // ============================================================
    gravityInput.addEventListener("input", (e) => {
      const g = parseFloat(e.target.value) || 0;
      engine.world.gravity.y = g;
    });

    addCoinBtn.addEventListener("click", () => {
      const x = REBA_LAUNCH_BASE_X + (Math.random() * 20 - 10);
      const y = REBA_LAUNCH_BASE_Y + (Math.random() * 10 - 5);
      addCoinAt(x, y);
    });

    resetWorldBtn.addEventListener("click", () => {
      coins.forEach(c => Composite.remove(world, c));
      coins.length = 0;
      addCoinAt(REBA_LAUNCH_BASE_X, REBA_LAUNCH_BASE_Y);
      leverAngleDeg = 0;
      updateLeverVisual();
    });

    // ============================================================
    // 画像ロードしてからスタート
    // ============================================================
    (async () => {
      try {
        await loadImage("map", `${base}/map.png`);
      } catch (e) {
        console.warn("map.png を読み込めませんでした", e);
      }
      // 画像のロード完了後にエンジンはすでに走っているので、そのまま表示される
    })();

    window.addEventListener("resize", () => {
      // 必要なら位置再計算やリロード
      // location.reload();
    });
  </script>
</body>
</html>
