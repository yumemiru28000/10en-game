<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>10円ゲーム & ミニゲーム集</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    h1, h2, h3 { text-align: center; }

    button {
      cursor: pointer;
      border: none;
      padding: 10px 20px;
      margin: 8px;
      font-size: 16px;
      border-radius: 6px;
      background: #caa55a;
      color: #222;
      box-shadow: 0 3px 0 #7b6432;
      transition: transform 0.05s ease, box-shadow 0.05s ease, filter 0.1s;
    }
    button:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #7b6432;
      filter: brightness(0.9);
    }
    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .screen {
      display: none;
      width: 100%;
      max-width: 640px;
      padding: 16px;
      box-sizing: border-box;
    }
    .screen.active { display: block; }

    .panel {
      background: #222;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 0 0 2px #555;
      margin-top: 16px;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 4px;
      border: 1px solid #666;
      box-sizing: border-box;
      background: #111;
      color: #eee;
    }

    .center { text-align: center; }

    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .small { font-size: 12px; opacity: 0.8; }

    /* 盤面＋左右のレバーUI */
    #gameOuter {
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 4px;
    }

    .leverColumnOuter {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      align-items: center;
      width: 80px;
    }

    #gameContainer {
      position: relative;
      width: 282px;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      border: 4px solid #5a4120;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }

    #gameCanvas {
      display: block;
      width: 100%;
      height: auto;
      background: #000;
    }

    .top-right-menu {
      position: fixed;
      top: 8px;
      right: 8px;
      z-index: 100;
    }

    .msg {
      margin-top: 6px;
      font-size: 13px;
      min-height: 1.4em;
    }

    .menu-title {
      font-size: 20px;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    .lever-ui {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      user-select: none;
    }

    .lever-image {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #666;
      background: #111;
      position: relative;
      flex-shrink: 0;
    }

    .lever-stick {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 4px;
      height: 18px;
      background: #ccc;
      transform-origin: bottom center;
      transform: translate(-50%, 0) rotate(0deg);
    }

    .lever-slider {
      width: 70px;
      pointer-events: none; /* ドラッグ専用にするのでクリックは効かない */
    }

    .lever-label {
      font-size: 11px;
      opacity: 0.9;
    }
  </style>
</head>
<body>

<div class="top-right-menu">
  <button id="backToMenuBtn" style="font-size:12px; padding:6px 10px;">メニューへ</button>
</div>

<!-- 0. 入口メニュー -->
<div id="screen-menu" class="screen active">
  <div class="panel">
    <h1 class="menu-title">ミニゲーム選択</h1>
    <div class="center">
      <button id="toNameInputBtn">10円ゲーム</button><br>
      <button id="toJankenBtn">じゃんけ��ゲーム</button>
    </div>
  </div>
</div>

<!-- 1. 名前入力画面 -->
<div id="screen-name" class="screen">
  <div class="panel">
    <h2>名前を入力してください</h2>
    <input type="text" id="playerNameInput" placeholder="未入力なら『Player』になります">
    <div class="center">
      <button id="decideNameBtn">決定</button>
    </div>
  </div>
</div>

<!-- 2. 10円ゲーム画面 -->
<div id="screen-10yen" class="screen">
  <div class="panel">
    <div class="status-bar">
      <div>PLAYING：<span id="playingName">-</span></div>
      <div>WAITING：<span id="waitingNames">0人</span></div>
    </div>
    <div class="small" id="stateLabel">状態：接続中...</div>

    <div id="gameOuter">
      <div id="leftLeverCol" class="leverColumnOuter"></div>
      <div id="gameContainer">
        <canvas id="gameCanvas" width="282" height="521"></canvas>
      </div>
      <div id="rightLeverCol" class="leverColumnOuter"></div>
    </div>

    <div class="center" style="margin-top:8px;">
      <button id="insertCoinBtn">10円を入れる</button>
      <button id="waitBtn">待機する</button>
      <button id="endGameBtn">ゲームを終わる</button>
    </div>

    <div class="msg" id="infoMsg"></div>
    <div class="small">
      ・誰もいない時：今なら遊べます<br>
      ・PLAYING：○○が挑戦中（観戦のみ）<br>
      ・待機：次に遊びたい人：n人
    </div>

    <div class="small" style="margin-top:6px;">
      ※ デバッグ：map=通常 / ren=赤 / ana=青 / atari=緑 / kaisi=黄 / reba=マゼンタ
    </div>
  </div>
</div>

<!-- 3. じゃんけんゲーム（仮） -->
<div id="screen-janken" class="screen">
  <div class="panel">
    <h2>じゃんけんゲーム（仮）</h2>
    <p class="small">ここは後で janken.html に分離予定。いったんダミー実装。</p>
    <div class="center">
      <button id="jankenDummyBtn">じゃんけん！（仮）</button>
      <div id="jankenResult" class="msg"></div>
    </div>
  </div>
</div>

<script type="module">
  // ========= Firebase 初期化 =========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  import {
    getDatabase,
    ref,
    onValue,
    set,
    update,
    push,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCC7KAv7V4j1Z6-o1Y8ikmb3r5htN9O_aA",
    authDomain: "zzgohan-280.firebaseapp.com",
    databaseURL: "https://zzgohan-280-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "zzgohan-280",
    storageBucket: "zzgohan-280.firebasestorage.app",
    messagingSenderId: "459336048542",
    appId: "1:459336048542:web:ff6c825dec81cc7df8008f",
    measurementId: "G-JX4RP9LWR3"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  // ========= 画面切り替え =========
  const screens = {
    menu: document.getElementById('screen-menu'),
    name: document.getElementById('screen-name'),
    ten: document.getElementById('screen-10yen'),
    janken: document.getElementById('screen-janken'),
  };
  function showScreen(key) {
    Object.values(screens).forEach(el => el.classList.remove('active'));
    screens[key].classList.add('active');
  }
  document.getElementById('toNameInputBtn').addEventListener('click', () => showScreen('name'));
  document.getElementById('toJankenBtn').addEventListener('click', () => showScreen('janken'));
  document.getElementById('backToMenuBtn').addEventListener('click', () => showScreen('menu'));

  // ========= 名前管理 =========
  const nameInput = document.getElementById('playerNameInput');
  const decideNameBtn = document.getElementById('decideNameBtn');
  let myName = localStorage.getItem('10yen_name') || '';
  if (myName) nameInput.value = myName;
  decideNameBtn.addEventListener('click', () => {
    const v = nameInput.value.trim();
    myName = v || 'Player';
    localStorage.setItem('10yen_name', myName);
    showScreen('ten');
  });

  // ========= Firebase 状態 =========
  const playingNameEl = document.getElementById('playingName');
  const waitingNamesEl = document.getElementById('waitingNames');
  const stateLabelEl = document.getElementById('stateLabel');
  const infoMsgEl = document.getElementById('infoMsg');

  const insertCoinBtn = document.getElementById('insertCoinBtn');
  const waitBtn = document.getElementById('waitBtn');
  const endGameBtn = document.getElementById('endGameBtn');

  const PLAYING_REF = ref(db, 'tenyenGame/playing');
  const WAITING_REF = ref(db, 'tenyenGame/waiting');
  const LAST_ACTION_REF = ref(db, 'tenyenGame/lastAction');

  let currentPlaying = null;
  let waitingList = [];

  function calcState() {
    if (!currentPlaying || !currentPlaying.name) return 'A';
    if (currentPlaying.name === myName) return 'C';
    return 'B';
  }

  const leverStates = []; // 定義だけ先に

  function setLeverEnabled(flag) {
    leverStates.forEach(l => {
      l.enabled = flag;
      l.slider.disabled = !flag;
    });
  }

  function updateUIState() {
    const st = calcState();
    if (st === 'A') {
      stateLabelEl.textContent = '状態：今なら遊べます';
      insertCoinBtn.disabled = false;
      waitBtn.disabled = false;
      endGameBtn.disabled = true;
      setLeverEnabled(false);
    } else if (st === 'B') {
      stateLabelEl.textContent = `状態：${currentPlaying?.name || '-'} が挑戦中（観戦中）`;
      insertCoinBtn.disabled = true;
      waitBtn.disabled = false;
      endGameBtn.disabled = true;
      setLeverEnabled(false);
    } else {
      stateLabelEl.textContent = '状態：あなたがプレイ中';
      insertCoinBtn.disabled = true;
      waitBtn.disabled = true;
      endGameBtn.disabled = false;
      setLeverEnabled(true);
    }

    if (waitingList.length === 0) {
      waitingNamesEl.textContent = '0人';
    } else {
      const names = waitingList.map(w => w.name).join(' / ');
      waitingNamesEl.textContent = `${waitingList.length}人（${names}）`;
    }
    playingNameEl.textContent = currentPlaying?.name || '-';
  }

  onValue(PLAYING_REF, snap => { currentPlaying = snap.val() || null; updateUIState(); });
  onValue(WAITING_REF, snap => {
    const val = snap.val() || {};
    waitingList = Object.keys(val).map(id => ({ id, name: val[id].name || 'Player' }));
    updateUIState();
  });

  function touchAction() {
    update(LAST_ACTION_REF, { time: serverTimestamp() });
  }

  insertCoinBtn.addEventListener('click', async () => {
    const st = calcState();
    if (st !== 'A') return;
    const name = myName || 'Player';
    await set(PLAYING_REF, { name });
    await set(WAITING_REF, {});
    touchAction();
    infoMsgEl.textContent = '10円が投入されました。レバーで狙ってください。';
    spawnCoinAtSafeStart();
  });

  waitBtn.addEventListener('click', async () => {
    const name = myName || 'Player';
    if (waitingList.find(w => w.name === name)) {
      infoMsgEl.textContent = 'すでに待機リストに入っています。';
      return;
    }
    const newRef = push(WAITING_REF);
    await set(newRef, { name, time: serverTimestamp() });
    touchAction();
    infoMsgEl.textContent = '待機列に入りました。譲り合って遊んでください。';
  });

  endGameBtn.addEventListener('click', async () => {
    const st = calcState();
    if (st !== 'C') return;
    await set(PLAYING_REF, null);
    touchAction();
    infoMsgEl.textContent = 'ゲームを終了しました。';
    resetCoin();
  });

  let idleTimer = null;
  ['click','input'].forEach(ev => {
    document.addEventListener(ev, () => {
      if (calcState() === 'C') {
        if (idleTimer) clearTimeout(idleTimer);
        idleTimer = setTimeout(async () => {
          if (calcState() === 'C') {
            await set(PLAYING_REF, null);
            infoMsgEl.textContent = '操作がなかったため、自動で終了しました。';
            resetCoin();
          }
        }, 60000);
      }
    });
  });

  // ========= PNG & 物理 =========
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const leftLeverCol = document.getElementById('leftLeverCol');
  const rightLeverCol = document.getElementById('rightLeverCol');

  const images = { map:null, ren:null, ana:null, atari:null, kaisi:null, reba:null, reba1:null };
  const hitCanvas = document.createElement('canvas');
  const hitCtx = hitCanvas.getContext('2d');
  let renData=null, anaData=null, atariData=null, kaisiData=null, rebaData=null;

  function loadImage(key,url){
    return new Promise((resolve,reject)=>{
      if(!url){resolve();return;}
      const img=new Image();
      img.crossOrigin="anonymous";
      img.onload=()=>{ images[key]=img; resolve(); };
      img.onerror=reject;
      img.src=url;
    });
  }

  async function loadAssets(){
    const base="https://raw.githubusercontent.com/yumemiru28000/10en-game/main";

    await loadImage('map',   `${base}/map.png`);
    await loadImage('ren',   `${base}/ren.png`);
    await loadImage('ana',   `${base}/ana.png`);
    await loadImage('atari', `${base}/atari.png`);
    await loadImage('kaisi', `${base}/kaisi.png`);
    await loadImage('reba',  `${base}/reba.png`);
    await loadImage('reba1', `${base}/reba1.png`);

    hitCanvas.width = canvas.width;
    hitCanvas.height= canvas.height;

    if(images.ren){
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.ren,0,0,hitCanvas.width,hitCanvas.height);
      renData=hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
    }
    if(images.ana){
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.ana,0,0,hitCanvas.width,hitCanvas.height);
      anaData=hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
    }
    if(images.atari){
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.atari,0,0,hitCanvas.width,hitCanvas.height);
      atariData=hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
    }
    if(images.kaisi){
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.kaisi,0,0,hitCanvas.width,hitCanvas.height);
      kaisiData=hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
      detectStartCandidate();
    }
    if(images.reba){
      hitCtx.clearRect(0,0,hitCanvas.width,hitCanvas.height);
      hitCtx.drawImage(images.reba,0,0,hitCanvas.width,hitCanvas.height);
      rebaData=hitCtx.getImageData(0,0,hitCanvas.width,hitCanvas.height);
    }

    setupLeversUI();
  }

  function isBlackPixel(imgData,x,y){
    if(!imgData) return false;
    const ix=Math.floor(x), iy=Math.floor(y);
    if(ix<0||iy<0||ix>=imgData.width||iy>=imgData.height) return false;
    const idx=(iy*imgData.width+ix)*4;
    const r=imgData.data[idx], g=imgData.data[idx+1], b=imgData.data[idx+2], a=imgData.data[idx+3];
    if(a<20) return false;
    const th=40;
    return (r<th && g<th && b<th);
  }

  const coin={ x:canvas.width/2, y:canvas.height/2, vx:0,vy:0,r:8,inPlay:false,cleared:false,failed:false,angle:0 };
  let startCandidates=[];

  function detectStartCandidate(){
    if(!kaisiData) return;
    const w=kaisiData.width,h=kaisiData.height;
    startCandidates=[];
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        if(isBlackPixel(kaisiData,x,y)) startCandidates.push({x,y});
      }
    }
    if(!startCandidates.length) startCandidates.push({x:w/2,y:h/2});
  }

  function spawnCoinAtSafeStart(){
    if(!startCandidates.length){
      coin.x=canvas.width/2; coin.y=canvas.height/2;
    }else{
      const cand=startCandidates[Math.floor(Math.random()*startCandidates.length)];
      let sx=cand.x, sy=cand.y;
      for(let dy=0;dy<20;dy++){
        const tx=sx, ty=sy+dy;
        let ok=true;
        for(let i=0;i<8;i++){
          const ang=Math.PI*2*i/8;
          const ex=tx+Math.cos(ang)*coin.r;
          const ey=ty+Math.sin(ang)*coin.r;
          if(renData && isBlackPixel(renData,ex,ey)){ ok=false; break; }
        }
        if(ok){ sx=tx; sy=ty; break; }
      }
      coin.x=sx; coin.y=sy;
    }
    coin.vx=0; coin.vy=0; coin.inPlay=true; coin.cleared=false; coin.failed=false; coin.angle=0;
  }

  function resetCoin(){ coin.inPlay=false; coin.cleared=false; coin.failed=false; }

  const gravity=0.7, friction=0.012, bounce=0.25;

  // 壁との衝突を最優先で解決（めり込み防止）
  function resolveWallCollision(){
    if(!renData) return;
    for(let iter=0;iter<3;iter++){ // 最大3回まで試す
      const sampleCount=16;
      let hitCount=0, nxSum=0, nySum=0;
      for(let i=0;i<sampleCount;i++){
        const ang=Math.PI*2*i/sampleCount;
        const sx=coin.x+Math.cos(ang)*coin.r;
        const sy=coin.y+Math.sin(ang)*coin.r;
        if(isBlackPixel(renData,sx,sy)){
          nxSum+=Math.cos(ang);
          nySum+=Math.sin(ang);
          hitCount++;
        }
      }
      if(!hitCount) break;
      let nx=nxSum/hitCount, ny=nySum/hitCount;
      const len=Math.sqrt(nx*nx+ny*ny)||1;
      nx/=len; ny/=len;
      // 速度の法線成分を完全に殺す
      const vDotN=coin.vx*nx+coin.vy*ny;
      const vnX=vDotN*nx, vnY=vDotN*ny;
      const vtX=coin.vx-vnX, vtY=coin.vy-vnY;
      coin.vx = vtX;
      coin.vy = vtY;
      // 外側に強く押し出す
      const pushOut=3.0;
      coin.x += nx*pushOut;
      coin.y += ny*pushOut;
    }
  }

  function updatePhysics(){
    if(!coin.inPlay || coin.cleared || coin.failed) return;

    // 1. 重力＋速度更新
    coin.vy += gravity;
    coin.vx *= (1-friction);
    coin.vy *= (1-friction);
    coin.x += coin.vx;
    coin.y += coin.vy;

    // 2. 壁との衝突を最優先で解決
    resolveWallCollision();

    // 3. 枠
    if(coin.x-coin.r<0){ coin.x=coin.r; coin.vx*=-bounce; }
    if(coin.x+coin.r>canvas.width){ coin.x=canvas.width-coin.r; coin.vx*=-bounce; }
    if(coin.y-coin.r<0){ coin.y=coin.r; coin.vy*=-bounce; }
    if(coin.y+coin.r>canvas.height){ coin.y=canvas.height-coin.r; coin.vy*=-bounce; }

    // 4. 失敗／成功
    if(anaData && isBlackPixel(anaData,coin.x,coin.y)){
      coin.inPlay=false; coin.failed=true; infoMsgEl.textContent='失敗…。また挑戦してね。';
    }
    if(atariData && !coin.failed && !coin.cleared && isBlackPixel(atariData,coin.x,coin.y)){
      coin.inPlay=false; coin.cleared=true; infoMsgEl.textContent='SUCCESS！おめでとう！';
    }

    // 5. 回転
    const speed=Math.sqrt(coin.vx*coin.vx+coin.vy*coin.vy);
    const maxSpin=0.25;
    const spin=Math.min(maxSpin,speed*0.03);
    coin.angle += spin;
  }

  // ========= レバーUI（長押しドラッグ） =========
  function setupLeversUI(){
    leftLeverCol.innerHTML='';
    rightLeverCol.innerHTML='';
    leverStates.length=0;

    const leftIds=[0,1,2];
    const rightIds=[3,4,5];

    leftIds.forEach((idx,i)=>{
      const ui=createLeverUI(idx,'left',`L${i+1}`);
      leftLeverCol.appendChild(ui.container);
      leverStates.push(ui.state);
    });
    rightIds.forEach((idx,i)=>{
      const ui=createLeverUI(idx,'right',`R${i+1}`);
      rightLeverCol.appendChild(ui.container);
      leverStates.push(ui.state);
    });
  }

  function createLeverUI(index,side,labelText){
    const container=document.createElement('div');
    container.className='lever-ui';

    const imgBox=document.createElement('div');
    imgBox.className='lever-image';
    if(images.reba1){
      imgBox.style.backgroundImage=`url(${images.reba1.src})`;
      imgBox.style.backgroundSize='cover';
      imgBox.style.backgroundPosition='center';
    }
    const stick=document.createElement('div');
    stick.className='lever-stick';
    imgBox.appendChild(stick);

    const slider=document.createElement('input');
    slider.type='range'; slider.min='0'; slider.max='100'; slider.step='1';
    slider.value='0'; slider.className='lever-slider';

    const label=document.createElement('div');
    label.className='lever-label';
    label.textContent=labelText;

    container.appendChild(imgBox);
    container.appendChild(slider);
    container.appendChild(label);

    const state={ index, side, slider, stick, value:0, storedValue:0, enabled:false };

    // ドラッグ用
    let dragging=false;
    let startY=0; // マウスのY位置
    let startValue=0;

    function onMouseDown(e){
      if(calcState()!=='C' || !state.enabled) return;
      dragging=true;
      startY=e.clientY;
      startValue=state.value;
      e.preventDefault();
    }
    function onMouseMove(e){
      if(!dragging) return;
      const dy = startY - e.clientY; // 上にドラッグでプラス
      // 重くする：値が高いほど増えにくい
      const stiffness = 1 + state.value/50;
      let newValue = startValue + (dy / stiffness);
      newValue = Math.max(0,Math.min(100,newValue));
      state.value = newValue;
      state.storedValue = Math.max(state.storedValue, newValue);
      slider.value = String(newValue);
      const ang=-90*(newValue/100);
      state.stick.style.transform=`translate(-50%, 0) rotate(${ang}deg)`;
      touchAction();
    }
    function onMouseUp(){
      if(!dragging) return;
      dragging=false;
      // 離した瞬間に発射
      if(state.storedValue>10){
        const power=state.storedValue/100;
        fireLever(state,power);
      }
      state.storedValue=0;
      state.value=0;
      slider.value='0';
      state.stick.style.transform='translate(-50%, 0) rotate(0deg)';
    }

    imgBox.addEventListener('mousedown',onMouseDown);
    // PC向け
    window.addEventListener('mousemove',onMouseMove);
    window.addEventListener('mouseup',onMouseUp);

    // タッチ対応
    imgBox.addEventListener('touchstart',e=>{
      if(calcState()!=='C' || !state.enabled) return;
      dragging=true;
      startY=e.touches[0].clientY;
      startValue=state.value;
      e.preventDefault();
    },{passive:false});
    window.addEventListener('touchmove',e=>{
      if(!dragging) return;
      const dy = startY - e.touches[0].clientY;
      const stiffness = 1 + state.value/50;
      let newValue = startValue + (dy / stiffness);
      newValue = Math.max(0,Math.min(100,newValue));
      state.value = newValue;
      state.storedValue = Math.max(state.storedValue, newValue);
      slider.value = String(newValue);
      const ang=-90*(newValue/100);
      state.stick.style.transform=`translate(-50%, 0) rotate(angdeg)`;
    },{passive:false});
    window.addEventListener('touchend',()=>{
      if(!dragging) return;
      dragging=false;
      if(state.storedValue>10){
        const power=state.storedValue/100;
        fireLever(state,power);
      }
      state.storedValue=0;
      state.value=0;
      slider.value='0';
      state.stick.style.transform='translate(-50%, 0) rotate(0deg)';
    });

    return { container, state };
  }

  // レバー打ち出し：reba黒上に10円がある時だけ
  function fireLever(lever,power){
    if(!coin.inPlay||coin.cleared||coin.failed) return;
    if(!rebaData) return;
    if(!isBlackPixel(rebaData,coin.x,coin.y)) return; // レバー付近以外は空振り

    const dirX=(lever.side==='left')?1:-1;
    const baseSpeed=16; // 強め
    const speed=baseSpeed*power;
    coin.vx += dirX*speed;
    coin.vy -= speed*0.5;
    infoMsgEl.textContent = `${lever.side==='left'?'左':'右'}レバーから発射！`;
  }

  // ========= 描画（全PNG可視化） =========
  function drawGame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // map
    if(images.map){
      ctx.globalAlpha=1.0;
      ctx.globalCompositeOperation='source-over';
      ctx.drawImage(images.map,0,0,canvas.width,canvas.height);
    }

    // ren: 赤
    if(images.ren){
      ctx.save();
      ctx.globalAlpha=0.3;
      ctx.fillStyle='rgba(255,0,0,0.3)';
      ctx.drawImage(images.ren,0,0,canvas.width,canvas.height);
      ctx.restore();
    }

    // ana: 青
    if(images.ana){
      ctx.save();
      ctx.globalAlpha=0.3;
      ctx.drawImage(images.ana,0,0,canvas.width,canvas.height);
      ctx.restore();
    }

    // atari: 緑
    if(images.atari){
      ctx.save();
      ctx.globalAlpha=0.4;
      ctx.drawImage(images.atari,0,0,canvas.width,canvas.height);
      ctx.restore();
    }

    // kaisi: 黄
    if(images.kaisi){
      ctx.save();
      ctx.globalAlpha=0.5;
      ctx.drawImage(images.kaisi,0,0,canvas.width,canvas.height);
      ctx.restore();
    }

    // reba: マゼンタ
    if(images.reba){
      ctx.save();
      ctx.globalAlpha=0.4;
      ctx.drawImage(images.reba,0,0,canvas.width,canvas.height);
      ctx.restore();
    }

    // 10円
    if(coin.inPlay||coin.cleared||coin.failed){
      ctx.save();
      ctx.translate(coin.x,coin.y);
      ctx.rotate(coin.angle);
      const grad=ctx.createRadialGradient(0,0,coin.r*0.2,0,0,coin.r);
      grad.addColorStop(0,'#ffe8a0');
      grad.addColorStop(1,'#c08a2a');
      ctx.fillStyle=grad;
      ctx.beginPath();
      ctx.arc(0,0,coin.r,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle='#5b3a10';
      ctx.font='bold 8px system-ui';
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.fillText('10',0,0);
      ctx.restore();
    }
  }

  function gameLoop(){ requestAnimationFrame(gameLoop); updatePhysics(); drawGame(); }

  // ========= じゃんけん（仮） =========
  const jankenDummyBtn=document.getElementById('jankenDummyBtn');
  const jankenResult=document.getElementById('jankenResult');
  jankenDummyBtn.addEventListener('click',()=>{
    const hands=['グー','チョキ','パー'];
    const my=hands[Math.floor(Math.random()*3)];
    const cpu=hands[Math.floor(Math.random()*3)];
    let res;
    if(my===cpu) res='あいこ';
    else if(
      (my==='グー'&&cpu==='チョキ')||
      (my==='チョキ'&&cpu==='パー')||
      (my==='パー'&&cpu==='グー')
    ) res='あなたの勝ち'; else res='あなたの負け';
    jankenResult.textContent=`あなた：${my} / CPU：${cpu} → ${res}`;
  });

  // ========= 初期化 =========
  loadAssets().then(()=>{
    spawnCoinAtSafeStart();
    gameLoop();
  });

</script>

</body>
</html>
